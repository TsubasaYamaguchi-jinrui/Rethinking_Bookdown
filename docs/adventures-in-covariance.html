<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>14 Adventures in Covariance | Statistical Rethinking Second Edition</title>
  <meta name="description" content="14 Adventures in Covariance | Statistical Rethinking Second Edition" />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="14 Adventures in Covariance | Statistical Rethinking Second Edition" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="14 Adventures in Covariance | Statistical Rethinking Second Edition" />
  
  
  

<meta name="author" content="Tsubasa Yamaguchi" />


<meta name="date" content="2023-02-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="models-with-memory.html"/>
<link rel="next" href="実行環境.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.6.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.27/datatables.js"></script>
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/tabwid-1.1.2/tabwid.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="custom_style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>本稿の目的</a></li>
<li class="chapter" data-level="" data-path="パッケージの読み込み.html"><a href="パッケージの読み込み.html"><i class="fa fa-check"></i>パッケージの読み込み</a></li>
<li class="chapter" data-level="1" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html"><i class="fa fa-check"></i><b>1</b> The Golem of Prague 　</a></li>
<li class="chapter" data-level="2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html"><i class="fa fa-check"></i><b>2</b> Small Worlds and Large Worlds</a>
<ul>
<li class="chapter" data-level="2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#byesian-updating"><i class="fa fa-check"></i><b>2.1</b> Byesian Updating</a></li>
<li class="chapter" data-level="2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#making-th-model"><i class="fa fa-check"></i><b>2.2</b> Making th model</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#grid-approximation"><i class="fa fa-check"></i><b>2.2.1</b> Grid approximation</a></li>
<li class="chapter" data-level="2.2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#quadratic-approximation"><i class="fa fa-check"></i><b>2.2.2</b> Quadratic approximation</a></li>
<li class="chapter" data-level="2.2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#mcmc"><i class="fa fa-check"></i><b>2.2.3</b> MCMC</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#practice"><i class="fa fa-check"></i><b>2.3</b> Practice</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#m1"><i class="fa fa-check"></i><b>2.3.1</b> 2M1</a></li>
<li class="chapter" data-level="2.3.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#m2"><i class="fa fa-check"></i><b>2.3.2</b> 2M2</a></li>
<li class="chapter" data-level="2.3.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#m3"><i class="fa fa-check"></i><b>2.3.3</b> 2M3</a></li>
<li class="chapter" data-level="2.3.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#m4"><i class="fa fa-check"></i><b>2.3.4</b> 2M4</a></li>
<li class="chapter" data-level="2.3.5" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#m5"><i class="fa fa-check"></i><b>2.3.5</b> 2M5</a></li>
<li class="chapter" data-level="2.3.6" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#m7"><i class="fa fa-check"></i><b>2.3.6</b> 2M7</a></li>
<li class="chapter" data-level="2.3.7" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#h1"><i class="fa fa-check"></i><b>2.3.7</b> 2H1</a></li>
<li class="chapter" data-level="2.3.8" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#h2"><i class="fa fa-check"></i><b>2.3.8</b> 2H2</a></li>
<li class="chapter" data-level="2.3.9" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#h3"><i class="fa fa-check"></i><b>2.3.9</b> 2H3</a></li>
<li class="chapter" data-level="2.3.10" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#h4"><i class="fa fa-check"></i><b>2.3.10</b> 2H4</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html"><i class="fa fa-check"></i><b>3</b> Sampling the Imaginary</a>
<ul>
<li class="chapter" data-level="3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-from-a-grid-aproximate-posterior"><i class="fa fa-check"></i><b>3.1</b> Sampling from a grid-aproximate posterior</a></li>
<li class="chapter" data-level="3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-summarize"><i class="fa fa-check"></i><b>3.2</b> Sampling to summarize</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-mass"><i class="fa fa-check"></i><b>3.2.1</b> Intervals of defined mass</a></li>
<li class="chapter" data-level="3.2.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#highly-skewed-example"><i class="fa fa-check"></i><b>3.2.2</b> highly skewed example</a></li>
<li class="chapter" data-level="3.2.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#point-estimate"><i class="fa fa-check"></i><b>3.2.3</b> Point estimate　　</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-simulate-prediction"><i class="fa fa-check"></i><b>3.3</b> Sampling to simulate prediction</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#model-checking"><i class="fa fa-check"></i><b>3.3.1</b> Model checking</a></li>
<li class="chapter" data-level="3.3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#practice-with-brms"><i class="fa fa-check"></i><b>3.3.2</b> Practice with brms</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#practice-1"><i class="fa fa-check"></i><b>3.4</b> Practice</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#e"><i class="fa fa-check"></i><b>3.4.1</b> 3E</a></li>
<li class="chapter" data-level="3.4.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#m"><i class="fa fa-check"></i><b>3.4.2</b> 3M</a></li>
<li class="chapter" data-level="3.4.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#h"><i class="fa fa-check"></i><b>3.4.3</b> 3H</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="geocentric-model.html"><a href="geocentric-model.html"><i class="fa fa-check"></i><b>4</b> Geocentric Model</a>
<ul>
<li class="chapter" data-level="4.1" data-path="geocentric-model.html"><a href="geocentric-model.html#why-normal-distributions-are-normal"><i class="fa fa-check"></i><b>4.1</b> Why normal distributions are normal</a></li>
<li class="chapter" data-level="4.2" data-path="geocentric-model.html"><a href="geocentric-model.html#normal-by-multiplication"><i class="fa fa-check"></i><b>4.2</b> Normal by multiplication</a></li>
<li class="chapter" data-level="4.3" data-path="geocentric-model.html"><a href="geocentric-model.html#gaussian-model-of-height"><i class="fa fa-check"></i><b>4.3</b> Gaussian model of height</a></li>
<li class="chapter" data-level="4.4" data-path="geocentric-model.html"><a href="geocentric-model.html#grid-approximationで事後分布を描く"><i class="fa fa-check"></i><b>4.4</b> Grid approximationで事後分布を描く</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="geocentric-model.html"><a href="geocentric-model.html#事後分布からサンプリングする"><i class="fa fa-check"></i><b>4.4.1</b> 事後分布からサンプリングする</a></li>
<li class="chapter" data-level="4.4.2" data-path="geocentric-model.html"><a href="geocentric-model.html#rethinking"><i class="fa fa-check"></i><b>4.4.2</b> rethinking</a></li>
<li class="chapter" data-level="4.4.3" data-path="geocentric-model.html"><a href="geocentric-model.html#finding-posterior-with-brms"><i class="fa fa-check"></i><b>4.4.3</b> Finding posterior with brms</a></li>
<li class="chapter" data-level="4.4.4" data-path="geocentric-model.html"><a href="geocentric-model.html#事後分布からのサンプリング"><i class="fa fa-check"></i><b>4.4.4</b> 事後分布からのサンプリング</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="geocentric-model.html"><a href="geocentric-model.html#linear-prediction"><i class="fa fa-check"></i><b>4.5</b> Linear prediction</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="geocentric-model.html"><a href="geocentric-model.html#finding-the-posterior-distribution"><i class="fa fa-check"></i><b>4.5.1</b> Finding the posterior distribution</a></li>
<li class="chapter" data-level="4.5.2" data-path="geocentric-model.html"><a href="geocentric-model.html#plotting-posterior-inference-agaist-the-data"><i class="fa fa-check"></i><b>4.5.2</b> Plotting posterior inference agaist the data</a></li>
<li class="chapter" data-level="4.5.3" data-path="geocentric-model.html"><a href="geocentric-model.html#plotting-regression-intervals-and-contours"><i class="fa fa-check"></i><b>4.5.3</b> Plotting regression intervals and contours</a></li>
<li class="chapter" data-level="4.5.4" data-path="geocentric-model.html"><a href="geocentric-model.html#prediction-intervals"><i class="fa fa-check"></i><b>4.5.4</b> Prediction intervals</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="geocentric-model.html"><a href="geocentric-model.html#curves-from-lines"><i class="fa fa-check"></i><b>4.6</b> Curves from lines</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="geocentric-model.html"><a href="geocentric-model.html#polynomial-regression"><i class="fa fa-check"></i><b>4.6.1</b> Polynomial regression</a></li>
<li class="chapter" data-level="4.6.2" data-path="geocentric-model.html"><a href="geocentric-model.html#overthinking"><i class="fa fa-check"></i><b>4.6.2</b> overthinking</a></li>
<li class="chapter" data-level="4.6.3" data-path="geocentric-model.html"><a href="geocentric-model.html#splines"><i class="fa fa-check"></i><b>4.6.3</b> Splines</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="geocentric-model.html"><a href="geocentric-model.html#practice-2"><i class="fa fa-check"></i><b>4.7</b> Practice</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="geocentric-model.html"><a href="geocentric-model.html#m1-2"><i class="fa fa-check"></i><b>4.7.1</b> 4M1</a></li>
<li class="chapter" data-level="4.7.2" data-path="geocentric-model.html"><a href="geocentric-model.html#m2-2"><i class="fa fa-check"></i><b>4.7.2</b> 4M2</a></li>
<li class="chapter" data-level="4.7.3" data-path="geocentric-model.html"><a href="geocentric-model.html#m4-2"><i class="fa fa-check"></i><b>4.7.3</b> 4M4</a></li>
<li class="chapter" data-level="4.7.4" data-path="geocentric-model.html"><a href="geocentric-model.html#m5-2"><i class="fa fa-check"></i><b>4.7.4</b> 4M5</a></li>
<li class="chapter" data-level="4.7.5" data-path="geocentric-model.html"><a href="geocentric-model.html#m6-1"><i class="fa fa-check"></i><b>4.7.5</b> 4M6</a></li>
<li class="chapter" data-level="4.7.6" data-path="geocentric-model.html"><a href="geocentric-model.html#m7-1"><i class="fa fa-check"></i><b>4.7.6</b> 4M7</a></li>
<li class="chapter" data-level="4.7.7" data-path="geocentric-model.html"><a href="geocentric-model.html#m8"><i class="fa fa-check"></i><b>4.7.7</b> 4M8</a></li>
<li class="chapter" data-level="4.7.8" data-path="geocentric-model.html"><a href="geocentric-model.html#h1-2"><i class="fa fa-check"></i><b>4.7.8</b> 4H1</a></li>
<li class="chapter" data-level="4.7.9" data-path="geocentric-model.html"><a href="geocentric-model.html#h2-2"><i class="fa fa-check"></i><b>4.7.9</b> 4H2</a></li>
<li class="chapter" data-level="4.7.10" data-path="geocentric-model.html"><a href="geocentric-model.html#h3-2"><i class="fa fa-check"></i><b>4.7.10</b> 4H3</a></li>
<li class="chapter" data-level="4.7.11" data-path="geocentric-model.html"><a href="geocentric-model.html#h4-2"><i class="fa fa-check"></i><b>4.7.11</b> 4H4</a></li>
<li class="chapter" data-level="4.7.12" data-path="geocentric-model.html"><a href="geocentric-model.html#h5-1"><i class="fa fa-check"></i><b>4.7.12</b> 4H5</a></li>
<li class="chapter" data-level="4.7.13" data-path="geocentric-model.html"><a href="geocentric-model.html#h6"><i class="fa fa-check"></i><b>4.7.13</b> 4H6</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html"><i class="fa fa-check"></i><b>5</b> The many variables &amp; the spurious waffles</a>
<ul>
<li class="chapter" data-level="5.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#spurious-association"><i class="fa fa-check"></i><b>5.1</b> Spurious association</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#グラフを用いて因果モデルを考える"><i class="fa fa-check"></i><b>5.1.1</b> グラフを用いて因果モデルを考える</a></li>
<li class="chapter" data-level="5.1.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#predictor-residual-plots"><i class="fa fa-check"></i><b>5.1.2</b> Predictor residual plots</a></li>
<li class="chapter" data-level="5.1.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#posterior-prediction-plots"><i class="fa fa-check"></i><b>5.1.3</b> Posterior prediction plots</a></li>
<li class="chapter" data-level="5.1.4" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#counterfactual-plot"><i class="fa fa-check"></i><b>5.1.4</b> Counterfactual plot</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#masked-relationship"><i class="fa fa-check"></i><b>5.2</b> Masked relationship</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#k-nモデル"><i class="fa fa-check"></i><b>5.2.1</b> K ~ Nモデル</a></li>
<li class="chapter" data-level="5.2.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#k-mモデル"><i class="fa fa-check"></i><b>5.2.2</b> K ~ Mモデル</a></li>
<li class="chapter" data-level="5.2.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#k-n-mモデル"><i class="fa fa-check"></i><b>5.2.3</b> K ~ N + Mモデル</a></li>
<li class="chapter" data-level="5.2.4" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#counterfactual-plot-を描く"><i class="fa fa-check"></i><b>5.2.4</b> Counterfactual plot を描く</a></li>
<li class="chapter" data-level="5.2.5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#overthinking-1"><i class="fa fa-check"></i><b>5.2.5</b> Overthinking</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#categorical-variables"><i class="fa fa-check"></i><b>5.3</b> Categorical variables</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#two-categories"><i class="fa fa-check"></i><b>5.3.1</b> Two categories</a></li>
<li class="chapter" data-level="5.3.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#many-categories"><i class="fa fa-check"></i><b>5.3.2</b> Many Categories</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#practice-3"><i class="fa fa-check"></i><b>5.4</b> Practice</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#m1-3"><i class="fa fa-check"></i><b>5.4.1</b> 5M1</a></li>
<li class="chapter" data-level="5.4.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#m2-3"><i class="fa fa-check"></i><b>5.4.2</b> 5M2</a></li>
<li class="chapter" data-level="5.4.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#m4-3"><i class="fa fa-check"></i><b>5.4.3</b> 5M4</a></li>
<li class="chapter" data-level="5.4.4" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#h1-3"><i class="fa fa-check"></i><b>5.4.4</b> 5H1</a></li>
<li class="chapter" data-level="5.4.5" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#h2-3"><i class="fa fa-check"></i><b>5.4.5</b> 5H2</a></li>
<li class="chapter" data-level="5.4.6" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#h3-3"><i class="fa fa-check"></i><b>5.4.6</b> 5H3</a></li>
<li class="chapter" data-level="5.4.7" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#h4-3"><i class="fa fa-check"></i><b>5.4.7</b> 5H4</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html"><i class="fa fa-check"></i><b>6</b> The Haunted DAG &amp; the Causal Terror</a>
<ul>
<li class="chapter" data-level="6.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinearity"><i class="fa fa-check"></i><b>6.1</b> Multicollinearity</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#multicollinear-milk"><i class="fa fa-check"></i><b>6.1.1</b> Multicollinear milk</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#post-treatment-bias"><i class="fa fa-check"></i><b>6.2</b> Post-treatment bias</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#blocked-by-consequence"><i class="fa fa-check"></i><b>6.2.1</b> Blocked by consequence</a></li>
<li class="chapter" data-level="6.2.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#fungus-and-d-separation"><i class="fa fa-check"></i><b>6.2.2</b> Fungus and d-separation</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-bias"><i class="fa fa-check"></i><b>6.3</b> Collider bias</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#collider-of-false-sorrow"><i class="fa fa-check"></i><b>6.3.1</b> Collider of false sorrow</a></li>
<li class="chapter" data-level="6.3.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#the-haunted-dag"><i class="fa fa-check"></i><b>6.3.2</b> The haunted DAG</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#confronting-confoundings"><i class="fa fa-check"></i><b>6.4</b> Confronting confoundings</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#two-roads"><i class="fa fa-check"></i><b>6.4.1</b> Two roads</a></li>
<li class="chapter" data-level="6.4.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#backdoor-waffles"><i class="fa fa-check"></i><b>6.4.2</b> Backdoor Waffles</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#practice-4"><i class="fa fa-check"></i><b>6.5</b> Practice</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#m1-4"><i class="fa fa-check"></i><b>6.5.1</b> 6M1</a></li>
<li class="chapter" data-level="6.5.2" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#m2-4"><i class="fa fa-check"></i><b>6.5.2</b> 6M2</a></li>
<li class="chapter" data-level="6.5.3" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#h1-4"><i class="fa fa-check"></i><b>6.5.3</b> 6H1</a></li>
<li class="chapter" data-level="6.5.4" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#h2-4"><i class="fa fa-check"></i><b>6.5.4</b> 6H2</a></li>
<li class="chapter" data-level="6.5.5" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#h3-4"><i class="fa fa-check"></i><b>6.5.5</b> 6H3</a></li>
<li class="chapter" data-level="6.5.6" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#h4-4"><i class="fa fa-check"></i><b>6.5.6</b> 6H4</a></li>
<li class="chapter" data-level="6.5.7" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#h5-2"><i class="fa fa-check"></i><b>6.5.7</b> 6H5</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="the-haunted-dag-the-causal-terror.html"><a href="the-haunted-dag-the-causal-terror.html#おまけ-ランダム効果を入れてみる"><i class="fa fa-check"></i><b>6.6</b> おまけ　ランダム効果を入れてみる</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ulysses-compass.html"><a href="ulysses-compass.html"><i class="fa fa-check"></i><b>7</b> Ulysses’ Compass</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#the-problems-with-parameters"><i class="fa fa-check"></i><b>7.1</b> The problems with parameters</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#more-parameters-always-improve-fit"><i class="fa fa-check"></i><b>7.1.1</b> More parameters always improve fit</a></li>
<li class="chapter" data-level="7.1.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#too-few-parameters-hurts-too"><i class="fa fa-check"></i><b>7.1.2</b> Too few parameters hurts too</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#entropy-and-accuracy"><i class="fa fa-check"></i><b>7.2</b> Entropy and accuracy</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-and-uncertainty"><i class="fa fa-check"></i><b>7.2.1</b> Information and uncertainty</a></li>
<li class="chapter" data-level="7.2.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#from-entropy-to-acculacy"><i class="fa fa-check"></i><b>7.2.2</b> From entropy to acculacy</a></li>
<li class="chapter" data-level="7.2.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#estimating-divergence"><i class="fa fa-check"></i><b>7.2.3</b> Estimating divergence</a></li>
<li class="chapter" data-level="7.2.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#scoring-the-right-data"><i class="fa fa-check"></i><b>7.2.4</b> Scoring the right data</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#golem-taming-regularization"><i class="fa fa-check"></i><b>7.3</b> Golem taming: regularization</a></li>
<li class="chapter" data-level="7.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#predicting-predictive-accuracy"><i class="fa fa-check"></i><b>7.4</b> Predicting predictive accuracy</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#cross-validation"><i class="fa fa-check"></i><b>7.4.1</b> Cross validation</a></li>
<li class="chapter" data-level="7.4.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#information-criteria"><i class="fa fa-check"></i><b>7.4.2</b> Information criteria</a></li>
<li class="chapter" data-level="7.4.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#overthinking-waic-calculation"><i class="fa fa-check"></i><b>7.4.3</b> overthinking: WAIC calculation</a></li>
<li class="chapter" data-level="7.4.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#comparing-cv-psis-and-waic"><i class="fa fa-check"></i><b>7.4.4</b> Comparing CV, PSIS, and WAIC</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-comparison"><i class="fa fa-check"></i><b>7.5</b> Model comparison</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#model-mis-selection"><i class="fa fa-check"></i><b>7.5.1</b> Model mis-selection</a></li>
<li class="chapter" data-level="7.5.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#outlier-and-other-illusions"><i class="fa fa-check"></i><b>7.5.2</b> Outlier and other illusions</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="ulysses-compass.html"><a href="ulysses-compass.html#practice-5"><i class="fa fa-check"></i><b>7.6</b> Practice</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="ulysses-compass.html"><a href="ulysses-compass.html#e2"><i class="fa fa-check"></i><b>7.6.1</b> 7E2</a></li>
<li class="chapter" data-level="7.6.2" data-path="ulysses-compass.html"><a href="ulysses-compass.html#e3"><i class="fa fa-check"></i><b>7.6.2</b> 7E3</a></li>
<li class="chapter" data-level="7.6.3" data-path="ulysses-compass.html"><a href="ulysses-compass.html#e4"><i class="fa fa-check"></i><b>7.6.3</b> 7E4</a></li>
<li class="chapter" data-level="7.6.4" data-path="ulysses-compass.html"><a href="ulysses-compass.html#m4-4"><i class="fa fa-check"></i><b>7.6.4</b> 7M4</a></li>
<li class="chapter" data-level="7.6.5" data-path="ulysses-compass.html"><a href="ulysses-compass.html#h1-5"><i class="fa fa-check"></i><b>7.6.5</b> 7H1</a></li>
<li class="chapter" data-level="7.6.6" data-path="ulysses-compass.html"><a href="ulysses-compass.html#h2-5"><i class="fa fa-check"></i><b>7.6.6</b> 7H2</a></li>
<li class="chapter" data-level="7.6.7" data-path="ulysses-compass.html"><a href="ulysses-compass.html#h3-5"><i class="fa fa-check"></i><b>7.6.7</b> 7H3</a></li>
<li class="chapter" data-level="7.6.8" data-path="ulysses-compass.html"><a href="ulysses-compass.html#h4-5"><i class="fa fa-check"></i><b>7.6.8</b> 7H4</a></li>
<li class="chapter" data-level="7.6.9" data-path="ulysses-compass.html"><a href="ulysses-compass.html#h5-3"><i class="fa fa-check"></i><b>7.6.9</b> 7H5</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conditional-manatees.html"><a href="conditional-manatees.html"><i class="fa fa-check"></i><b>8</b> Conditional Manatees</a>
<ul>
<li class="chapter" data-level="8.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#building-an-interaction"><i class="fa fa-check"></i><b>8.1</b> Building an interaction</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#making-a-rugged-model"><i class="fa fa-check"></i><b>8.1.1</b> Making a rugged model</a></li>
<li class="chapter" data-level="8.1.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-an-indicator-variable-isnt-enough"><i class="fa fa-check"></i><b>8.1.2</b> Adding an indicator variable isn’t enough</a></li>
<li class="chapter" data-level="8.1.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#adding-interaction-does-work"><i class="fa fa-check"></i><b>8.1.3</b> Adding interaction does work</a></li>
<li class="chapter" data-level="8.1.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-the-interaction"><i class="fa fa-check"></i><b>8.1.4</b> Plotting the interaction</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#symmetry-of-interaction"><i class="fa fa-check"></i><b>8.2</b> Symmetry of interaction</a></li>
<li class="chapter" data-level="8.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#continuous-interaction"><i class="fa fa-check"></i><b>8.3</b> Continuous interaction</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#a-winter-flower"><i class="fa fa-check"></i><b>8.3.1</b> A winter flower</a></li>
<li class="chapter" data-level="8.3.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#the-models"><i class="fa fa-check"></i><b>8.3.2</b> The models</a></li>
<li class="chapter" data-level="8.3.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-posterior-predictions"><i class="fa fa-check"></i><b>8.3.3</b> Plotting posterior predictions</a></li>
<li class="chapter" data-level="8.3.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#plotting-prior-predictions"><i class="fa fa-check"></i><b>8.3.4</b> Plotting prior predictions</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#practice-6"><i class="fa fa-check"></i><b>8.4</b> Practice</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="conditional-manatees.html"><a href="conditional-manatees.html#m4-5"><i class="fa fa-check"></i><b>8.4.1</b> 8M4</a></li>
<li class="chapter" data-level="8.4.2" data-path="conditional-manatees.html"><a href="conditional-manatees.html#h1-6"><i class="fa fa-check"></i><b>8.4.2</b> 8H1</a></li>
<li class="chapter" data-level="8.4.3" data-path="conditional-manatees.html"><a href="conditional-manatees.html#h2-6"><i class="fa fa-check"></i><b>8.4.3</b> 8H2</a></li>
<li class="chapter" data-level="8.4.4" data-path="conditional-manatees.html"><a href="conditional-manatees.html#h3-6"><i class="fa fa-check"></i><b>8.4.4</b> 8H3</a></li>
<li class="chapter" data-level="8.4.5" data-path="conditional-manatees.html"><a href="conditional-manatees.html#h4-6"><i class="fa fa-check"></i><b>8.4.5</b> 8H4</a></li>
<li class="chapter" data-level="8.4.6" data-path="conditional-manatees.html"><a href="conditional-manatees.html#h5-4"><i class="fa fa-check"></i><b>8.4.6</b> 8H5</a></li>
<li class="chapter" data-level="8.4.7" data-path="conditional-manatees.html"><a href="conditional-manatees.html#h6-1"><i class="fa fa-check"></i><b>8.4.7</b> 8H6</a></li>
<li class="chapter" data-level="8.4.8" data-path="conditional-manatees.html"><a href="conditional-manatees.html#h7"><i class="fa fa-check"></i><b>8.4.8</b> 8H7</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html"><i class="fa fa-check"></i><b>9</b> Marcov Chain Monte Carlo</a>
<ul>
<li class="chapter" data-level="9.1" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#good-king-marcov-and-his-island-kingdom"><i class="fa fa-check"></i><b>9.1</b> Good King Marcov and his island kingdom</a></li>
<li class="chapter" data-level="9.2" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#metropolis-algorythm"><i class="fa fa-check"></i><b>9.2</b> Metropolis algorythm</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#gibbs-sampling"><i class="fa fa-check"></i><b>9.2.1</b> Gibbs sampling</a></li>
<li class="chapter" data-level="9.2.2" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#high-dimentional-problem"><i class="fa fa-check"></i><b>9.2.2</b> High-dimentional problem</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#hamiltonian-monte-carlo"><i class="fa fa-check"></i><b>9.3</b> Hamiltonian Monte Carlo</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#another-probable"><i class="fa fa-check"></i><b>9.3.1</b> Another probable</a></li>
<li class="chapter" data-level="9.3.2" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#limitations"><i class="fa fa-check"></i><b>9.3.2</b> Limitations</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#easy-hmc-ulam-brm"><i class="fa fa-check"></i><b>9.4</b> Easy HMC: <del>ulam</del> <code>brm()</code></a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#preparation"><i class="fa fa-check"></i><b>9.4.1</b> Preparation</a></li>
<li class="chapter" data-level="9.4.2" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#sampling-from-posterior"><i class="fa fa-check"></i><b>9.4.2</b> Sampling from posterior</a></li>
<li class="chapter" data-level="9.4.3" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#sampling-again-in-parallel"><i class="fa fa-check"></i><b>9.4.3</b> Sampling again in parallel</a></li>
<li class="chapter" data-level="9.4.4" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#visualization"><i class="fa fa-check"></i><b>9.4.4</b> Visualization</a></li>
<li class="chapter" data-level="9.4.5" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#checking-the-chain"><i class="fa fa-check"></i><b>9.4.5</b> Checking the chain</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#care-and-feeding-of-your-marcov-chain"><i class="fa fa-check"></i><b>9.5</b> Care and feeding of your Marcov chain</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#how-many-samples-do-you-need"><i class="fa fa-check"></i><b>9.5.1</b> How many samples do you need</a></li>
<li class="chapter" data-level="9.5.2" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#how-many-chains-do-we-need"><i class="fa fa-check"></i><b>9.5.2</b> How many chains do we need</a></li>
<li class="chapter" data-level="9.5.3" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#taming-and-wild-chain"><i class="fa fa-check"></i><b>9.5.3</b> Taming and wild chain</a></li>
<li class="chapter" data-level="9.5.4" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#non-identifiable-parameters"><i class="fa fa-check"></i><b>9.5.4</b> Non-identifiable parameters</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#practice-7"><i class="fa fa-check"></i><b>9.6</b> Practice</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#m1-5"><i class="fa fa-check"></i><b>9.6.1</b> 9M1</a></li>
<li class="chapter" data-level="9.6.2" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#m2-5"><i class="fa fa-check"></i><b>9.6.2</b> 9M2</a></li>
<li class="chapter" data-level="9.6.3" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#m3-2"><i class="fa fa-check"></i><b>9.6.3</b> 9M3</a></li>
<li class="chapter" data-level="9.6.4" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#h1-7"><i class="fa fa-check"></i><b>9.6.4</b> 9H1</a></li>
<li class="chapter" data-level="9.6.5" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#h2-7"><i class="fa fa-check"></i><b>9.6.5</b> 9H2</a></li>
<li class="chapter" data-level="9.6.6" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#h3-7"><i class="fa fa-check"></i><b>9.6.6</b> 9H3</a></li>
<li class="chapter" data-level="9.6.7" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#h4-7"><i class="fa fa-check"></i><b>9.6.7</b> 9H4</a></li>
<li class="chapter" data-level="9.6.8" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#h5-5"><i class="fa fa-check"></i><b>9.6.8</b> 9H5</a></li>
<li class="chapter" data-level="9.6.9" data-path="marcov-chain-monte-carlo.html"><a href="marcov-chain-monte-carlo.html#h6-2"><i class="fa fa-check"></i><b>9.6.9</b> 9H6</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html"><i class="fa fa-check"></i><b>10</b> Big Entropy and the Generalized Linear Model</a>
<ul>
<li class="chapter" data-level="10.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#maximum-entropy"><i class="fa fa-check"></i><b>10.1</b> Maximum entropy</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#gaussian"><i class="fa fa-check"></i><b>10.1.1</b> Gaussian</a></li>
<li class="chapter" data-level="10.1.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#binomial"><i class="fa fa-check"></i><b>10.1.2</b> Binomial</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#generalized-linear-models"><i class="fa fa-check"></i><b>10.2</b> Generalized linear models</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#meet-the-family"><i class="fa fa-check"></i><b>10.2.1</b> Meet the family</a></li>
<li class="chapter" data-level="10.2.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#linking-linear-models-to-distributions"><i class="fa fa-check"></i><b>10.2.2</b> Linking linear models to distributions</a></li>
<li class="chapter" data-level="10.2.3" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#overthinking-2"><i class="fa fa-check"></i><b>10.2.3</b> Overthinking</a></li>
<li class="chapter" data-level="10.2.4" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#omitted-variable-bias-again"><i class="fa fa-check"></i><b>10.2.4</b> Omitted variable bias again</a></li>
<li class="chapter" data-level="10.2.5" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#absolute-and-relative-differences"><i class="fa fa-check"></i><b>10.2.5</b> Absolute and relative differences</a></li>
<li class="chapter" data-level="10.2.6" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#glms-and-information-criteria"><i class="fa fa-check"></i><b>10.2.6</b> GLMs and information criteria</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html"><i class="fa fa-check"></i><b>11</b> God Spiked the Integers</a>
<ul>
<li class="chapter" data-level="11.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#binomial-regression"><i class="fa fa-check"></i><b>11.1</b> Binomial regression</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#logistic-regression"><i class="fa fa-check"></i><b>11.1.1</b> Logistic regression</a></li>
<li class="chapter" data-level="11.1.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#relative-shark-and-absolute-deer"><i class="fa fa-check"></i><b>11.1.2</b> Relative shark and absolute deer</a></li>
<li class="chapter" data-level="11.1.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-chimpanzees-again-condensed"><i class="fa fa-check"></i><b>11.1.3</b> Aggregated binomial: Chimpanzees again, condensed</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#aggregated-binomial-graduate-school-admittions."><i class="fa fa-check"></i><b>11.2</b> Aggregated binomial: Graduate school admittions.</a></li>
<li class="chapter" data-level="11.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#poisson-regression"><i class="fa fa-check"></i><b>11.3</b> Poisson regression</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#oceanic-tool-complexity"><i class="fa fa-check"></i><b>11.3.1</b> Oceanic tool complexity</a></li>
<li class="chapter" data-level="11.3.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#negative-binomial-gamma-poisson-models."><i class="fa fa-check"></i><b>11.3.2</b> Negative binomial (Gamma-Poisson) models.</a></li>
<li class="chapter" data-level="11.3.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#example-exposure-and-the-offset"><i class="fa fa-check"></i><b>11.3.3</b> Example: Exposure and the offset</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#multinomial-and-categorical-models"><i class="fa fa-check"></i><b>11.4</b> Multinomial and categorical models</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#predictors-matched-to-outcomes"><i class="fa fa-check"></i><b>11.4.1</b> Predictors matched to outcomes</a></li>
<li class="chapter" data-level="11.4.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#predictor-matched-to-observations"><i class="fa fa-check"></i><b>11.4.2</b> Predictor matched to observations</a></li>
<li class="chapter" data-level="11.4.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#multinomial-in-disguise-as-poisson"><i class="fa fa-check"></i><b>11.4.3</b> Multinomial in disguise as Poisson</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#practice-8"><i class="fa fa-check"></i><b>11.5</b> Practice</a>
<ul>
<li class="chapter" data-level="11.5.1" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#e1"><i class="fa fa-check"></i><b>11.5.1</b> 11E1</a></li>
<li class="chapter" data-level="11.5.2" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#e2-1"><i class="fa fa-check"></i><b>11.5.2</b> 11E2</a></li>
<li class="chapter" data-level="11.5.3" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#e3-1"><i class="fa fa-check"></i><b>11.5.3</b> 11E3</a></li>
<li class="chapter" data-level="11.5.4" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#e4-1"><i class="fa fa-check"></i><b>11.5.4</b> 11E4</a></li>
<li class="chapter" data-level="11.5.5" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#m7-2"><i class="fa fa-check"></i><b>11.5.5</b> 11M7</a></li>
<li class="chapter" data-level="11.5.6" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#m8-1"><i class="fa fa-check"></i><b>11.5.6</b> 11M8</a></li>
<li class="chapter" data-level="11.5.7" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#h1-8"><i class="fa fa-check"></i><b>11.5.7</b> 11H1</a></li>
<li class="chapter" data-level="11.5.8" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#h2-8"><i class="fa fa-check"></i><b>11.5.8</b> 11H2</a></li>
<li class="chapter" data-level="11.5.9" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#h3-8"><i class="fa fa-check"></i><b>11.5.9</b> 11H3</a></li>
<li class="chapter" data-level="11.5.10" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#h4-8"><i class="fa fa-check"></i><b>11.5.10</b> 11H4</a></li>
<li class="chapter" data-level="11.5.11" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#h5-6"><i class="fa fa-check"></i><b>11.5.11</b> 11H5</a></li>
<li class="chapter" data-level="11.5.12" data-path="god-spiked-the-integers.html"><a href="god-spiked-the-integers.html#h6-3"><i class="fa fa-check"></i><b>11.5.12</b> 11H6</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html"><i class="fa fa-check"></i><b>12</b> Monsters and Mixtures</a>
<ul>
<li class="chapter" data-level="12.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersed-counts"><i class="fa fa-check"></i><b>12.1</b> Over-dispersed counts</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#beta-binomial."><i class="fa fa-check"></i><b>12.1.1</b> Beta binomial.</a></li>
<li class="chapter" data-level="12.1.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#negative-binomial-or-gamma-poisson."><i class="fa fa-check"></i><b>12.1.2</b> Negative binomial or gamma-Poisson.</a></li>
<li class="chapter" data-level="12.1.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersion-entropy-and-information-criteria."><i class="fa fa-check"></i><b>12.1.3</b> Over-dispersion, entropy, and information criteria.</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#zero-inflated-outcomes"><i class="fa fa-check"></i><b>12.2</b> Zero-inflated outcomes</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-zero-inflated-poisson."><i class="fa fa-check"></i><b>12.2.1</b> Example: Zero-inflated Poisson.</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-outcomes"><i class="fa fa-check"></i><b>12.3</b> Ordered categorical outcomes</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-moral-intuition."><i class="fa fa-check"></i><b>12.3.1</b> Example: Moral intuition.</a></li>
<li class="chapter" data-level="12.3.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#adding-predictor-variables."><i class="fa fa-check"></i><b>12.3.2</b> Adding predictor variables.</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-predictors"><i class="fa fa-check"></i><b>12.4</b> Ordered categorical predictors</a></li>
<li class="chapter" data-level="12.5" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#practice-9"><i class="fa fa-check"></i><b>12.5</b> Practice</a>
<ul>
<li class="chapter" data-level="12.5.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#m1-6"><i class="fa fa-check"></i><b>12.5.1</b> 12M1</a></li>
<li class="chapter" data-level="12.5.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#m2-6"><i class="fa fa-check"></i><b>12.5.2</b> 12M2</a></li>
<li class="chapter" data-level="12.5.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#m3-3"><i class="fa fa-check"></i><b>12.5.3</b> 12M3</a></li>
<li class="chapter" data-level="12.5.4" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#h1-9"><i class="fa fa-check"></i><b>12.5.4</b> 12H1</a></li>
<li class="chapter" data-level="12.5.5" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#h2-9"><i class="fa fa-check"></i><b>12.5.5</b> 12H2</a></li>
<li class="chapter" data-level="12.5.6" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#h3-9"><i class="fa fa-check"></i><b>12.5.6</b> 12H3</a></li>
<li class="chapter" data-level="12.5.7" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#h4-9"><i class="fa fa-check"></i><b>12.5.7</b> 12H4</a></li>
<li class="chapter" data-level="12.5.8" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#h5-7"><i class="fa fa-check"></i><b>12.5.8</b> 12H5</a></li>
<li class="chapter" data-level="12.5.9" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#h6-4"><i class="fa fa-check"></i><b>12.5.9</b> 12H6</a></li>
<li class="chapter" data-level="12.5.10" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#h7-1"><i class="fa fa-check"></i><b>12.5.10</b> 12H7</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="models-with-memory.html"><a href="models-with-memory.html"><i class="fa fa-check"></i><b>13</b> Models with Memory</a>
<ul>
<li class="chapter" data-level="13.1" data-path="models-with-memory.html"><a href="models-with-memory.html#multilevel-tadpoles"><i class="fa fa-check"></i><b>13.1</b> Multilevel tadpoles</a></li>
<li class="chapter" data-level="13.2" data-path="models-with-memory.html"><a href="models-with-memory.html#varying-effects-and-the-underfittingoverfitting-trade-off"><i class="fa fa-check"></i><b>13.2</b> Varying effects and the underfitting/overfitting trade-off 　</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="models-with-memory.html"><a href="models-with-memory.html#the-model"><i class="fa fa-check"></i><b>13.2.1</b> The model</a></li>
<li class="chapter" data-level="13.2.2" data-path="models-with-memory.html"><a href="models-with-memory.html#simulate-survivors"><i class="fa fa-check"></i><b>13.2.2</b> Simulate survivors</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="models-with-memory.html"><a href="models-with-memory.html#more-than-one-type-of-cluster"><i class="fa fa-check"></i><b>13.3</b> More than one type of cluster</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="models-with-memory.html"><a href="models-with-memory.html#even-more-clusters"><i class="fa fa-check"></i><b>13.3.1</b> Even more clusters</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="models-with-memory.html"><a href="models-with-memory.html#divergent-transitions-and-non-centered-priors"><i class="fa fa-check"></i><b>13.4</b> Divergent transitions and non-centered priors</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="models-with-memory.html"><a href="models-with-memory.html#the-devils-funnel"><i class="fa fa-check"></i><b>13.4.1</b> The Devil’s Funnel</a></li>
<li class="chapter" data-level="13.4.2" data-path="models-with-memory.html"><a href="models-with-memory.html#non-centered-chimpanzees"><i class="fa fa-check"></i><b>13.4.2</b> Non-centered chimpanzees</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="models-with-memory.html"><a href="models-with-memory.html#multilevel-posterior-predictions"><i class="fa fa-check"></i><b>13.5</b> Multilevel posterior predictions</a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="models-with-memory.html"><a href="models-with-memory.html#posterior-prediction-for-same-clusters"><i class="fa fa-check"></i><b>13.5.1</b> Posterior prediction for same clusters</a></li>
<li class="chapter" data-level="13.5.2" data-path="models-with-memory.html"><a href="models-with-memory.html#posterior-prediction-for-new-clusters"><i class="fa fa-check"></i><b>13.5.2</b> Posterior prediction for new clusters</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="models-with-memory.html"><a href="models-with-memory.html#post-stratification"><i class="fa fa-check"></i><b>13.6</b> Post stratification</a>
<ul>
<li class="chapter" data-level="13.6.1" data-path="models-with-memory.html"><a href="models-with-memory.html#meet-the-data"><i class="fa fa-check"></i><b>13.6.1</b> Meet the data</a></li>
<li class="chapter" data-level="13.6.2" data-path="models-with-memory.html"><a href="models-with-memory.html#settle-the-mr-part-of-mrp."><i class="fa fa-check"></i><b>13.6.2</b> Settle the MR part of MRP.</a></li>
<li class="chapter" data-level="13.6.3" data-path="models-with-memory.html"><a href="models-with-memory.html#post-stratify-to-put-the-p-in-mrp."><i class="fa fa-check"></i><b>13.6.3</b> Post-stratify to put the P in MRP.</a></li>
</ul></li>
<li class="chapter" data-level="13.7" data-path="models-with-memory.html"><a href="models-with-memory.html#practice-10"><i class="fa fa-check"></i><b>13.7</b> Practice</a>
<ul>
<li class="chapter" data-level="13.7.1" data-path="models-with-memory.html"><a href="models-with-memory.html#m1-7"><i class="fa fa-check"></i><b>13.7.1</b> 13M1</a></li>
<li class="chapter" data-level="13.7.2" data-path="models-with-memory.html"><a href="models-with-memory.html#m2-7"><i class="fa fa-check"></i><b>13.7.2</b> 13M2</a></li>
<li class="chapter" data-level="13.7.3" data-path="models-with-memory.html"><a href="models-with-memory.html#m3-4"><i class="fa fa-check"></i><b>13.7.3</b> 13M3</a></li>
<li class="chapter" data-level="13.7.4" data-path="models-with-memory.html"><a href="models-with-memory.html#m4-6"><i class="fa fa-check"></i><b>13.7.4</b> 13M4</a></li>
<li class="chapter" data-level="13.7.5" data-path="models-with-memory.html"><a href="models-with-memory.html#m5-3"><i class="fa fa-check"></i><b>13.7.5</b> 13M5</a></li>
<li class="chapter" data-level="13.7.6" data-path="models-with-memory.html"><a href="models-with-memory.html#m6-2"><i class="fa fa-check"></i><b>13.7.6</b> 13M6</a></li>
<li class="chapter" data-level="13.7.7" data-path="models-with-memory.html"><a href="models-with-memory.html#h1-10"><i class="fa fa-check"></i><b>13.7.7</b> 13H1</a></li>
<li class="chapter" data-level="13.7.8" data-path="models-with-memory.html"><a href="models-with-memory.html#h2-10"><i class="fa fa-check"></i><b>13.7.8</b> 13H2</a></li>
<li class="chapter" data-level="13.7.9" data-path="models-with-memory.html"><a href="models-with-memory.html#h3-10"><i class="fa fa-check"></i><b>13.7.9</b> 13H3</a></li>
<li class="chapter" data-level="13.7.10" data-path="models-with-memory.html"><a href="models-with-memory.html#h4-10"><i class="fa fa-check"></i><b>13.7.10</b> 13H4</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html"><i class="fa fa-check"></i><b>14</b> Adventures in Covariance</a>
<ul>
<li class="chapter" data-level="14.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#varying-slopes-by-construction"><i class="fa fa-check"></i><b>14.1</b> Varying slopes by construction</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-and-population"><i class="fa fa-check"></i><b>14.1.1</b> Simulate and population</a></li>
<li class="chapter" data-level="14.1.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-observation"><i class="fa fa-check"></i><b>14.1.2</b> Simulate observation</a></li>
<li class="chapter" data-level="14.1.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#the-varying-slope-model"><i class="fa fa-check"></i><b>14.1.3</b> The varying slope model</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#advanced-varing-slopes"><i class="fa fa-check"></i><b>14.2</b> Advanced varing slopes</a></li>
<li class="chapter" data-level="14.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#instruments-and-causal-designs"><i class="fa fa-check"></i><b>14.3</b> Instruments and causal designs</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#instrumental-variables"><i class="fa fa-check"></i><b>14.3.1</b> Instrumental variables</a></li>
<li class="chapter" data-level="14.3.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#other-designs"><i class="fa fa-check"></i><b>14.3.2</b> Other designs</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#social-relations-as-correlated-varying-effects"><i class="fa fa-check"></i><b>14.4</b> Social relations as correlated varying effects</a></li>
<li class="chapter" data-level="14.5" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#continuous-categories-and-the-gaussian-process"><i class="fa fa-check"></i><b>14.5</b> Continuous categories and the Gaussian process</a>
<ul>
<li class="chapter" data-level="14.5.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-spatial-autocorrelation-in-oceanic-tools"><i class="fa fa-check"></i><b>14.5.1</b> Example: Spatial autocorrelation in Oceanic tools</a></li>
<li class="chapter" data-level="14.5.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-phylogenetic-distance"><i class="fa fa-check"></i><b>14.5.2</b> Example: Phylogenetic distance</a></li>
</ul></li>
<li class="chapter" data-level="14.6" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#practice-11"><i class="fa fa-check"></i><b>14.6</b> Practice</a>
<ul>
<li class="chapter" data-level="14.6.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#m1-8"><i class="fa fa-check"></i><b>14.6.1</b> 14M1</a></li>
<li class="chapter" data-level="14.6.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#m2-8"><i class="fa fa-check"></i><b>14.6.2</b> 14M2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="実行環境.html"><a href="実行環境.html"><i class="fa fa-check"></i>実行環境</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Statistical Rethinking Second Edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="adventures-in-covariance" class="section level1 hasAnchor" number="14">
<h1><span class="header-section-number">14</span> Adventures in Covariance<a href="adventures-in-covariance.html#adventures-in-covariance" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="varying-slopes-by-construction" class="section level2 hasAnchor" number="14.1">
<h2><span class="header-section-number">14.1</span> Varying slopes by construction<a href="adventures-in-covariance.html#varying-slopes-by-construction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>ランダム切片とランダム傾きの両方を推定するためには、多変量正規分布を用いる必要がある。</p>
<div id="simulate-and-population" class="section level3 hasAnchor" number="14.1.1">
<h3><span class="header-section-number">14.1.1</span> Simulate and population<a href="adventures-in-covariance.html#simulate-and-population" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>ロボットがカフェを訪れた際の待ち時間に関するデータをシミュレートする。パラメータは以下のとおりとする。すなわち、ランダム切片とランダム傾きは平均と標準偏差がそれぞれ3.5と-1, 1と0.7の多変量正規分布から得られるとする。なお、分散共分散行列は通常以下のようにあらわす。なお、<span class="math inline">\(\sigma_{\alpha}\)</span>と<span class="math inline">\(\sigma_{\beta}\)</span>はそれぞれランダム切片とランダム傾きのばらつき（標準偏差）を表し、<span class="math inline">\(\rho\)</span>はそれらの相関を表す。</p>
<p><span class="math display">\[
\sum =
\begin{bmatrix}
  \sigma_{\alpha}^2 &amp; \sigma_{\alpha}\sigma_{\beta}\rho\\
  \sigma_{\alpha}\sigma_{\beta}\rho &amp; \sigma_{\beta}
\end{bmatrix}
\]</span></p>
<div class="sourceCode" id="cb1192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1192-1"><a href="adventures-in-covariance.html#cb1192-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fl">3.5</span>         <span class="co"># averange morning wait time  </span></span>
<span id="cb1192-2"><a href="adventures-in-covariance.html#cb1192-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="dv">1</span>)          <span class="co"># average difference afternoon wait time  </span></span>
<span id="cb1192-3"><a href="adventures-in-covariance.html#cb1192-3" aria-hidden="true" tabindex="-1"></a>sigma_a <span class="ot">&lt;-</span> <span class="dv">1</span>     <span class="co"># std dev in intercepts   </span></span>
<span id="cb1192-4"><a href="adventures-in-covariance.html#cb1192-4" aria-hidden="true" tabindex="-1"></a>sigma_b <span class="ot">&lt;-</span> <span class="fl">0.5</span>   <span class="co"># std dev in slopes  </span></span>
<span id="cb1192-5"><a href="adventures-in-covariance.html#cb1192-5" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="fl">0.7</span>)     <span class="co"># correlation between interecpts and slopes</span></span>
<span id="cb1192-6"><a href="adventures-in-covariance.html#cb1192-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1192-7"><a href="adventures-in-covariance.html#cb1192-7" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(a,b) </span>
<span id="cb1192-8"><a href="adventures-in-covariance.html#cb1192-8" aria-hidden="true" tabindex="-1"></a>cov_ab <span class="ot">&lt;-</span> sigma_a<span class="sc">*</span>sigma_b<span class="sc">*</span>rho <span class="co">#共分散</span></span>
<span id="cb1192-9"><a href="adventures-in-covariance.html#cb1192-9" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(sigma_a<span class="sc">^</span><span class="dv">2</span>, cov_ab, </span>
<span id="cb1192-10"><a href="adventures-in-covariance.html#cb1192-10" aria-hidden="true" tabindex="-1"></a>                  cov_ab, sigma_b<span class="sc">^</span><span class="dv">2</span>), <span class="at">ncol=</span><span class="dv">2</span>)　<span class="co"># 分散共分散行列</span></span></code></pre></div>
<p>なお、分散共分散行列は以下のようにしても作成できる。</p>
<div class="sourceCode" id="cb1193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1193-1"><a href="adventures-in-covariance.html#cb1193-1" aria-hidden="true" tabindex="-1"></a>sigmas <span class="ot">&lt;-</span> <span class="fu">c</span>(sigma_a, sigma_b)</span>
<span id="cb1193-2"><a href="adventures-in-covariance.html#cb1193-2" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho,</span>
<span id="cb1193-3"><a href="adventures-in-covariance.html#cb1193-3" aria-hidden="true" tabindex="-1"></a>              rho, <span class="dv">1</span>), <span class="at">nrow =</span><span class="dv">2</span>)</span>
<span id="cb1193-4"><a href="adventures-in-covariance.html#cb1193-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1193-5"><a href="adventures-in-covariance.html#cb1193-5" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fu">diag</span>(sigmas) <span class="sc">%*%</span> rho <span class="sc">%*%</span> <span class="fu">diag</span>(sigmas) </span></code></pre></div>
<p>それでは、それぞれのお店（N=20）の切片と傾きをシミュレートする。</p>
<div class="sourceCode" id="cb1194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1194-1"><a href="adventures-in-covariance.html#cb1194-1" aria-hidden="true" tabindex="-1"></a>n_cafes <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb1194-2"><a href="adventures-in-covariance.html#cb1194-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1194-3"><a href="adventures-in-covariance.html#cb1194-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5</span>)</span>
<span id="cb1194-4"><a href="adventures-in-covariance.html#cb1194-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1194-5"><a href="adventures-in-covariance.html#cb1194-5" aria-hidden="true" tabindex="-1"></a>vary_effects <span class="ot">&lt;-</span> </span>
<span id="cb1194-6"><a href="adventures-in-covariance.html#cb1194-6" aria-hidden="true" tabindex="-1"></a>  MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n_cafes, mu, sigma) <span class="sc">%&gt;%</span> </span>
<span id="cb1194-7"><a href="adventures-in-covariance.html#cb1194-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1194-8"><a href="adventures-in-covariance.html#cb1194-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="st">&quot;a_cafe&quot;</span>, <span class="st">&quot;b_cafe&quot;</span>)</span>
<span id="cb1194-9"><a href="adventures-in-covariance.html#cb1194-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1194-10"><a href="adventures-in-covariance.html#cb1194-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vary_effects)</span></code></pre></div>
<pre><code>##     a_cafe     b_cafe
## 1 4.223962 -1.6093565
## 2 2.010498 -0.7517704
## 3 4.565811 -1.9482646
## 4 3.343635 -1.1926539
## 5 1.700971 -0.5855618
## 6 4.134373 -1.1444539</code></pre>
<p><img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-672-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="simulate-observation" class="section level3 hasAnchor" number="14.1.2">
<h3><span class="header-section-number">14.1.2</span> Simulate observation<a href="adventures-in-covariance.html#simulate-observation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>それでは、それぞれのお店を10回訪れたときのデータをシミュレートする。</p>
<div class="sourceCode" id="cb1196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1196-1"><a href="adventures-in-covariance.html#cb1196-1" aria-hidden="true" tabindex="-1"></a>n_visits <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb1196-2"><a href="adventures-in-covariance.html#cb1196-2" aria-hidden="true" tabindex="-1"></a>sigma_y <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1196-3"><a href="adventures-in-covariance.html#cb1196-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1196-4"><a href="adventures-in-covariance.html#cb1196-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb1196-5"><a href="adventures-in-covariance.html#cb1196-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1196-6"><a href="adventures-in-covariance.html#cb1196-6" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> </span>
<span id="cb1196-7"><a href="adventures-in-covariance.html#cb1196-7" aria-hidden="true" tabindex="-1"></a>  vary_effects <span class="sc">%&gt;%</span> </span>
<span id="cb1196-8"><a href="adventures-in-covariance.html#cb1196-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cafe =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb1196-9"><a href="adventures-in-covariance.html#cb1196-9" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">expand</span>(<span class="fu">nesting</span>(cafe, a_cafe, b_cafe),</span>
<span id="cb1196-10"><a href="adventures-in-covariance.html#cb1196-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">visits =</span> <span class="dv">1</span><span class="sc">:</span>n_visits) <span class="sc">%&gt;%</span> </span>
<span id="cb1196-11"><a href="adventures-in-covariance.html#cb1196-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">afternoon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">times =</span> <span class="fu">n</span>()<span class="sc">/</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1196-12"><a href="adventures-in-covariance.html#cb1196-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu =</span> a_cafe <span class="sc">+</span> b_cafe<span class="sc">*</span>afternoon) <span class="sc">%&gt;%</span> </span>
<span id="cb1196-13"><a href="adventures-in-covariance.html#cb1196-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wait =</span> <span class="fu">rnorm</span>(<span class="at">n=</span><span class="fu">n</span>(), <span class="at">mean=</span>mu, <span class="at">sd=</span>sigma_y))</span>
<span id="cb1196-14"><a href="adventures-in-covariance.html#cb1196-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1196-15"><a href="adventures-in-covariance.html#cb1196-15" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> </span>
<span id="cb1196-16"><a href="adventures-in-covariance.html#cb1196-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 7
##     cafe a_cafe b_cafe visits afternoon    mu  wait
##    &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;int&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1     2   2.01 -0.752      4         1  1.26  1.22
##  2    14   3.51 -1.44      10         1  2.07  2.98
##  3    10   3.47 -0.680      5         0  3.47  3.67
##  4    20   3.77 -1.06      10         1  2.72  3.63
##  5     4   3.34 -1.19       1         0  3.34  3.61
##  6    13   4.30 -2.11       4         1  2.19  1.21
##  7     5   1.70 -0.586      1         0  1.70  1.59
##  8    10   3.47 -0.680      3         0  3.47  3.69
##  9     1   4.22 -1.61       4         1  2.61  2.76
## 10    17   4.22 -0.919      5         0  4.22  4.08</code></pre>
<p>実際のデータをカフェ2とカフェ8について描写してみる。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-674-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="the-varying-slope-model" class="section level3 hasAnchor" number="14.1.3">
<h3><span class="header-section-number">14.1.3</span> The varying slope model<a href="adventures-in-covariance.html#the-varying-slope-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>それでは、モデリングを行う。モデル式は以下の通り。</p>
<p><span class="math display">\[
\begin{aligned}
  W_{i} &amp;\sim Normal(\mu_{i}, \sigma)\\
  \mu_{i} &amp;= \alpha_{cafe[i]} + \beta_{cafe[i]}A_{i}\\
  \begin{bmatrix}
    \alpha_{cafe} \\ \beta_{cafe}
  \end{bmatrix}
    &amp;\sim MVNormal(
  \begin{bmatrix}
     \alpha \\ \beta
  \end{bmatrix}, \mathbf{S})\\
  \mathbf{S} &amp;=
       \begin{bmatrix}
          \sigma_{\alpha} &amp; 0 \\
          0 &amp; \sigma_{\beta}
        \end{bmatrix}
        \mathbf{R}
        \begin{bmatrix}
          \sigma_{\alpha} &amp; 0 \\
          0 &amp; \sigma_{\beta}
        \end{bmatrix}\\
  \mathbf{R} &amp;= \begin{bmatrix}
          1 &amp; \rho \\
          \rho &amp; 1
        \end{bmatrix}\\
  \alpha &amp;\sim Normal(5,2)\\
  \beta &amp;\sim Normal(-1,0.5)\\
  \sigma &amp;\sim Exponential(1)\\
  \sigma_{\alpha} &amp;\sim Exponential(1)\\
  \sigma_{\beta} &amp;\sim Exponential(1)\\
  mathbf{R} &amp;\sim LKJcorr(2)\\
\end{aligned}
\]</span></p>
<p><br /></p>
<p>なお、<span class="math inline">\(LKJcorr\)</span>分布は以下のようなパラメータ<span class="math inline">\(\eta\)</span>を持つ分布である。<span class="math inline">\(\eta=1\)</span>のときは一様分布で、<span class="math inline">\(\eta\)</span>が大きくなるほど分布が狭くなっていく。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-675-1.png" width="672" style="display: block; margin: auto;" />
<br /></p>
<p>それでは、モデリングを行う。</p>
<div class="sourceCode" id="cb1198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1198-1"><a href="adventures-in-covariance.html#cb1198-1" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.1</span> <span class="ot">&lt;-</span> </span>
<span id="cb1198-2"><a href="adventures-in-covariance.html#cb1198-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span>d,</span>
<span id="cb1198-3"><a href="adventures-in-covariance.html#cb1198-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1198-4"><a href="adventures-in-covariance.html#cb1198-4" aria-hidden="true" tabindex="-1"></a>      wait <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> afternoon <span class="sc">+</span> (<span class="dv">1</span><span class="sc">+</span>afternoon<span class="sc">|</span>cafe),</span>
<span id="cb1198-5"><a href="adventures-in-covariance.html#cb1198-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb1198-6"><a href="adventures-in-covariance.html#cb1198-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">class =</span> b),</span>
<span id="cb1198-7"><a href="adventures-in-covariance.html#cb1198-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma),</span>
<span id="cb1198-8"><a href="adventures-in-covariance.html#cb1198-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span>sd),</span>
<span id="cb1198-9"><a href="adventures-in-covariance.html#cb1198-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">2</span>), <span class="at">class =</span> cor)),</span>
<span id="cb1198-10"><a href="adventures-in-covariance.html#cb1198-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1198-11"><a href="adventures-in-covariance.html#cb1198-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">155</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.1&quot;</span>)</span></code></pre></div>
<p>切片と傾きの相関の事前分布と事後分布は以下の通り。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-677-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>各カフェの切片と傾きの推定値と元データを比較したものが以下の図である。モデルによる推定値では全体の平均へと縮合が起きていることが分かる。</p>
<p>続いて、午前と午後の待ち時間の元データとモデルによる推定値は以下の通り。同様に縮合が生じていることが分かる。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-679-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="advanced-varing-slopes" class="section level2 hasAnchor" number="14.2">
<h2><span class="header-section-number">14.2</span> Advanced varing slopes<a href="adventures-in-covariance.html#advanced-varing-slopes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>チンパンジーの実験データ<span class="citation">(<a href="#ref-Silk2005" role="doc-biblioref">Silk et al. 2005</a>)</span>を用いて、2つ以上ランダム傾きを用いるモデルを考える。</p>
<div class="sourceCode" id="cb1199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1199-1"><a href="adventures-in-covariance.html#cb1199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(chimpanzees)</span>
<span id="cb1199-2"><a href="adventures-in-covariance.html#cb1199-2" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> chimpanzees</span>
<span id="cb1199-3"><a href="adventures-in-covariance.html#cb1199-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1199-4"><a href="adventures-in-covariance.html#cb1199-4" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> </span>
<span id="cb1199-5"><a href="adventures-in-covariance.html#cb1199-5" aria-hidden="true" tabindex="-1"></a>  d2 <span class="sc">%&gt;%</span> </span>
<span id="cb1199-6"><a href="adventures-in-covariance.html#cb1199-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">actor =</span> <span class="fu">factor</span>(actor),</span>
<span id="cb1199-7"><a href="adventures-in-covariance.html#cb1199-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">block =</span> <span class="fu">factor</span>(block),</span>
<span id="cb1199-8"><a href="adventures-in-covariance.html#cb1199-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">treatment =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">+</span>prosoc_left <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>condition),</span>
<span id="cb1199-9"><a href="adventures-in-covariance.html#cb1199-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">labels =</span> <span class="fu">factor</span>(treatment, <span class="at">levels =</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb1199-10"><a href="adventures-in-covariance.html#cb1199-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;r/n&quot;</span>,<span class="st">&quot;l/n&quot;</span>,<span class="st">&quot;r/p&quot;</span>,<span class="st">&quot;l/p&quot;</span>)))</span></code></pre></div>
<p>モデル式は以下のようになる。以下のモデルでは、各個体、各ブロックによって条件（treatment）の効果が変わることを想定している。</p>
<p><span class="math display">\[
\begin{aligned}
  L_{i} &amp;\sim Binomial(1,p_{i})\\
  logit(p_{i}) &amp;= \gamma_{TID[i]} + \alpha_{ACTOR[i],TID[i]}+
  \beta_{BLOCK[i],TID[i]}\\
  \gamma_{j} &amp;\sim Normal(0,1)\\
  \begin{bmatrix}
  \alpha_{j,1}\\ \alpha_{j,2}\\ \alpha_{j,3}\\ \alpha_{j,4}
  \end{bmatrix}
  &amp; \sim MVNormal(
  \begin{bmatrix}
  0\\0\\0\\0
  \end{bmatrix}
  , \sum_{ACTOR})\\
  \begin{bmatrix}
  \beta_{j,1}\\ \beta_{j,2}\\ \beta_{j,3}\\ \beta_{j,4}
  \end{bmatrix}
  &amp; \sim MVNormal(
  \begin{bmatrix}
  0\\0\\0\\0
  \end{bmatrix}
  , \sum_{BLOCK})\\
  \sum_{ACTOR} &amp;= \mathbf{S}_{\alpha}\mathbf{R}_{\alpha}\mathbf{S}_{\alpha}\\
  \sum_{BLOCK} &amp;= \mathbf{S}_{\beta}\mathbf{R}_{\beta}\mathbf{S}_{\beta}\\
  \mathbf{S}_{\alpha} &amp;=
  \begin{bmatrix}
     \sigma_{\alpha,[1]}&amp;0&amp;0&amp;0\\
     0&amp;\sigma_{\alpha,[2]}&amp;0&amp;0\\
     0&amp;0&amp;\sigma_{\alpha,[3]}&amp;0\\
     0&amp;0&amp;0&amp;\sigma_{\alpha,[4]}
  \end{bmatrix}\\
  \mathbf{S}_{\beta} &amp;=
  \begin{bmatrix}
     \sigma_{\beta,[1]}&amp;0&amp;0&amp;0\\
     0&amp;\sigma_{\beta,[2]}&amp;0&amp;0\\
     0&amp;0&amp;\sigma_{\beta,[3]}&amp;0\\
     0&amp;0&amp;0&amp;\sigma_{\beta,[4]}
  \end{bmatrix}\\
\mathbf{R}_{\alpha} &amp;=
    \begin{bmatrix}
     1&amp;\rho_{\alpha,[1,2]} &amp; \rho_{\alpha,[1,3]} &amp; \rho_{\alpha,[1,4]}\\
     \rho_{\alpha,[2,1]} &amp; 1 &amp;\rho_{\alpha,[2,3]} &amp; \rho_{\alpha,[2,4]}\\
      \rho_{\alpha,[3,1]} &amp; \rho_{\alpha,[3,2]} &amp; 1 &amp; \rho_{\alpha,[3,4]}\\
      \rho_{\alpha,[4,1]} &amp; \rho_{\alpha,[4,2]} &amp; \rho_{\alpha,[4,3]} &amp; 1\\
  \end{bmatrix}\\
  \mathbf{R}_{\beta} &amp;=
    \begin{bmatrix}
     1&amp;\rho_{\beta,[1,2]} &amp; \rho_{\beta,[1,3]} &amp; \rho_{\beta,[1,4]}\\
     \rho_{\beta,[2,1]} &amp; 1 &amp;\rho_{\beta,[2,3]} &amp; \rho_{\beta,[2,4]}\\
      \rho_{\beta,[3,1]} &amp; \rho_{\beta,[3,2]} &amp; 1 &amp; \rho_{\beta,[3,4]}\\
      \rho_{\beta,[4,1]} &amp; \rho_{\beta,[4,2]} &amp; \rho_{\beta,[4,3]} &amp; 1\\
  \end{bmatrix}\\
  \sigma_{\alpha,[1]},...\sigma_{\alpha,[4]} &amp;\sim Exponential(1)\\
  \sigma_{\beta,[1]},...\sigma_{\beta,[4]} &amp;\sim Exponential(1)\\
  \mathbf{R}_{\alpha} &amp;\sim LKJ(2)\\
  \mathbf{R}_{\beta} &amp;\sim LKJ(2)
\end{aligned}
\]</span>
<br/></p>
<p>それでは、<code>brms</code>でモデルを回す。</p>
<div class="sourceCode" id="cb1200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1200-1"><a href="adventures-in-covariance.html#cb1200-1" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.3</span> <span class="ot">&lt;-</span> </span>
<span id="cb1200-2"><a href="adventures-in-covariance.html#cb1200-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span>d2,</span>
<span id="cb1200-3"><a href="adventures-in-covariance.html#cb1200-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> bernoulli,</span>
<span id="cb1200-4"><a href="adventures-in-covariance.html#cb1200-4" aria-hidden="true" tabindex="-1"></a>      pulled_left <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> treatment <span class="sc">+</span> (<span class="dv">0</span><span class="sc">+</span>treatment<span class="sc">|</span>actor) <span class="sc">+</span> </span>
<span id="cb1200-5"><a href="adventures-in-covariance.html#cb1200-5" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">0</span><span class="sc">+</span>treatment<span class="sc">|</span>block),</span>
<span id="cb1200-6"><a href="adventures-in-covariance.html#cb1200-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> b),</span>
<span id="cb1200-7"><a href="adventures-in-covariance.html#cb1200-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd),</span>
<span id="cb1200-8"><a href="adventures-in-covariance.html#cb1200-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">2</span>), <span class="at">class =</span> cor)),</span>
<span id="cb1200-9"><a href="adventures-in-covariance.html#cb1200-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1200-10"><a href="adventures-in-covariance.html#cb1200-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.3&quot;</span>)</span></code></pre></div>
<p>ランダム切片の標準偏差は以下の通り（表<a href="adventures-in-covariance.html#tab:res-b14-3">14.1</a>）。</p>
<div class="sourceCode" id="cb1201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1201-1"><a href="adventures-in-covariance.html#cb1201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(b14<span class="fl">.3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1201-2"><a href="adventures-in-covariance.html#cb1201-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1201-3"><a href="adventures-in-covariance.html#cb1201-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;par&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1201-4"><a href="adventures-in-covariance.html#cb1201-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(par,<span class="st">&quot;sd&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1201-5"><a href="adventures-in-covariance.html#cb1201-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb1201-6"><a href="adventures-in-covariance.html#cb1201-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1201-7"><a href="adventures-in-covariance.html#cb1201-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="st">&quot;b14.3の結果。&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1201-8"><a href="adventures-in-covariance.html#cb1201-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">&quot;striped&quot;</span>, <span class="st">&quot;hold_position&quot;</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-3">表14.1: </span>b14.3の結果。
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
sd_actor__treatment1
</td>
<td style="text-align:right;">
1.40
</td>
<td style="text-align:right;">
0.49
</td>
<td style="text-align:right;">
0.70
</td>
<td style="text-align:right;">
2.62
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_actor__treatment2
</td>
<td style="text-align:right;">
0.92
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.33
</td>
<td style="text-align:right;">
1.94
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_actor__treatment3
</td>
<td style="text-align:right;">
1.86
</td>
<td style="text-align:right;">
0.58
</td>
<td style="text-align:right;">
1.02
</td>
<td style="text-align:right;">
3.27
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_actor__treatment4
</td>
<td style="text-align:right;">
1.60
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:right;">
0.74
</td>
<td style="text-align:right;">
3.15
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_block__treatment1
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.33
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
1.25
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_block__treatment2
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.34
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
1.27
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_block__treatment3
</td>
<td style="text-align:right;">
0.30
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
0.99
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_block__treatment4
</td>
<td style="text-align:right;">
0.48
</td>
<td style="text-align:right;">
0.38
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
1.37
</td>
</tr>
</tbody>
</table>
<p>結果を図示すると以下の通り。青い点は実データを表す。以前のモデルよりも、個体ごとのばらつきをうまく表現することができている。また、縮合が生じていることも分かる（特にactor2）。また、標準偏差が小さかった条件（treatment1と2）でより縮合が生じていることも分かる。
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-682-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="instruments-and-causal-designs" class="section level2 hasAnchor" number="14.3">
<h2><span class="header-section-number">14.3</span> Instruments and causal designs<a href="adventures-in-covariance.html#instruments-and-causal-designs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="instrumental-variables" class="section level3 hasAnchor" number="14.3.1">
<h3><span class="header-section-number">14.3.1</span> Instrumental variables<a href="adventures-in-covariance.html#instrumental-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>教育が賃金に与える影響を検証したいとする。しかし、単に賃金を教育の程度で回帰したとしても、その因果関係を知ることはできない。例えば、両方に対して影響を与えている共通の要因が考えられるからである（下図）。</p>
<p><img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-683-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>このようなとき、以下の基準を満たす<em>instrumental variable</em>を用いることでこのような状況を克服することができることがある。</p>
<ol style="list-style-type: decimal">
<li>Uとは独立（<span class="math inline">\(U\bot Q\)</span>）<br />
</li>
<li>Eと独立でない（<span class="math inline">\(E\not\bot Q\)</span>）<br />
</li>
<li>QはEを通してのみWに影響を与える。</li>
</ol>
<p>そのようなQをDAGで表すと以下のようになる。例えば、この例では生まれたのがいずれの四半期にあたるのかをQとして用いることができるかもしれない<span class="citation">(<a href="#ref-angrist1991" role="doc-biblioref">Angrist and Keueger 1991</a>)</span>。これは、早く生まれた人ほど学校教育を受けない傾向があることによる。このとき、QとEを同時に説明変数に含めるとEで条件づけるとQとUが独立ではなくなり（EはQとUの合流点であるため）、結果的にQとWも独立ではなくなる。その結果、さらにEの係数が交絡するので、Qは<span class="math inline">\(\color{blue}{\text{BIAS AMPLIFIER}}\)</span>と呼べる。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-684-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>それでは、上のDAGに基づいてデータをシミュレートする。ここでは、教育による収入への影響はないものとする。</p>
<div class="sourceCode" id="cb1202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1202-1"><a href="adventures-in-covariance.html#cb1202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">73</span>)</span>
<span id="cb1202-2"><a href="adventures-in-covariance.html#cb1202-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb1202-3"><a href="adventures-in-covariance.html#cb1202-3" aria-hidden="true" tabindex="-1"></a>dat_sim <span class="ot">&lt;-</span> </span>
<span id="cb1202-4"><a href="adventures-in-covariance.html#cb1202-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">u_sim =</span> <span class="fu">rnorm</span>(n,<span class="at">mean=</span><span class="dv">0</span>,<span class="at">sd=</span><span class="dv">1</span>),</span>
<span id="cb1202-5"><a href="adventures-in-covariance.html#cb1202-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">q_sim =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">size=</span>n, <span class="at">replace=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1202-6"><a href="adventures-in-covariance.html#cb1202-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_sim =</span> <span class="fu">rnorm</span>(n, <span class="at">mean=</span>u_sim <span class="sc">+</span> q_sim, <span class="at">sd=</span><span class="dv">1</span>),</span>
<span id="cb1202-7"><a href="adventures-in-covariance.html#cb1202-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">w_sim =</span> <span class="fu">rnorm</span>(n, <span class="at">mean=</span>u_sim <span class="sc">+</span> <span class="dv">0</span><span class="sc">*</span>e_sim, <span class="at">sd =</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1202-8"><a href="adventures-in-covariance.html#cb1202-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> <span class="fu">standardize</span>(w_sim),</span>
<span id="cb1202-9"><a href="adventures-in-covariance.html#cb1202-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">e =</span> <span class="fu">standardize</span>(e_sim),</span>
<span id="cb1202-10"><a href="adventures-in-covariance.html#cb1202-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">q =</span> <span class="fu">standardize</span>(q_sim))</span>
<span id="cb1202-11"><a href="adventures-in-covariance.html#cb1202-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1202-12"><a href="adventures-in-covariance.html#cb1202-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat_sim)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 7
##     u_sim q_sim e_sim   w_sim w           e           q         
##     &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dw_trnsf&gt;  &lt;dw_trnsf&gt;  &lt;dw_trnsf&gt;
## 1 -0.145      1 1.51   0.216   0.17252701 -0.57472658 -1.3562176
## 2  0.291      1 0.664  0.846   0.58357373 -1.08822480 -1.3562176
## 3  0.0938     3 2.44  -0.664  -0.40238235 -0.01850495  0.4282792
## 4 -0.127      3 4.09  -0.725  -0.44241750  0.97829629  0.4282792
## 5 -0.847      4 2.62  -1.24   -0.78028083  0.09392642  1.3205276
## 6  0.141      4 3.54  -0.0700 -0.01457435  0.65088153  1.3205276</code></pre>
<p>それでは、モデリングを行う。まずは、Qを含めないモデル。</p>
<div class="sourceCode" id="cb1204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1204-1"><a href="adventures-in-covariance.html#cb1204-1" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.4</span> <span class="ot">&lt;-</span> </span>
<span id="cb1204-2"><a href="adventures-in-covariance.html#cb1204-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span> dat_sim,</span>
<span id="cb1204-3"><a href="adventures-in-covariance.html#cb1204-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1204-4"><a href="adventures-in-covariance.html#cb1204-4" aria-hidden="true" tabindex="-1"></a>      w <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> e,</span>
<span id="cb1204-5"><a href="adventures-in-covariance.html#cb1204-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb1204-6"><a href="adventures-in-covariance.html#cb1204-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">class =</span> b),</span>
<span id="cb1204-7"><a href="adventures-in-covariance.html#cb1204-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb1204-8"><a href="adventures-in-covariance.html#cb1204-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1204-9"><a href="adventures-in-covariance.html#cb1204-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span><span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.4&quot;</span></span>
<span id="cb1204-10"><a href="adventures-in-covariance.html#cb1204-10" aria-hidden="true" tabindex="-1"></a>      )</span></code></pre></div>
<p>結果は以下の通り（表<a href="adventures-in-covariance.html#tab:res-b14-4">14.2</a>）。教育の影響はないにもかかわらず、交絡によって係数が正になっていることが分かる。</p>
<div class="sourceCode" id="cb1205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1205-1"><a href="adventures-in-covariance.html#cb1205-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(b14<span class="fl">.4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1205-2"><a href="adventures-in-covariance.html#cb1205-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1205-3"><a href="adventures-in-covariance.html#cb1205-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;par&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1205-4"><a href="adventures-in-covariance.html#cb1205-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(par <span class="sc">!=</span> <span class="st">&quot;lp__&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1205-5"><a href="adventures-in-covariance.html#cb1205-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb1205-6"><a href="adventures-in-covariance.html#cb1205-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1205-7"><a href="adventures-in-covariance.html#cb1205-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="st">&quot;b14.4の結果&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1205-8"><a href="adventures-in-covariance.html#cb1205-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">&quot;striped&quot;</span>, <span class="st">&quot;hold_position&quot;</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-4">表14.2: </span>b14.4の結果
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_Intercept
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
-0.08
</td>
<td style="text-align:right;">
0.08
</td>
</tr>
<tr>
<td style="text-align:left;">
b_e
</td>
<td style="text-align:right;">
0.40
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.32
</td>
<td style="text-align:right;">
0.48
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma
</td>
<td style="text-align:right;">
0.92
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.86
</td>
<td style="text-align:right;">
0.98
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-0.80
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
-0.96
</td>
<td style="text-align:right;">
-0.66
</td>
</tr>
</tbody>
</table>
<p>続いて、Qを含めたモデルを考える。</p>
<div class="sourceCode" id="cb1206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1206-1"><a href="adventures-in-covariance.html#cb1206-1" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.5</span> <span class="ot">&lt;-</span> </span>
<span id="cb1206-2"><a href="adventures-in-covariance.html#cb1206-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span> dat_sim,</span>
<span id="cb1206-3"><a href="adventures-in-covariance.html#cb1206-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1206-4"><a href="adventures-in-covariance.html#cb1206-4" aria-hidden="true" tabindex="-1"></a>      w <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> e <span class="sc">+</span> q,</span>
<span id="cb1206-5"><a href="adventures-in-covariance.html#cb1206-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb1206-6"><a href="adventures-in-covariance.html#cb1206-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">class =</span> b),</span>
<span id="cb1206-7"><a href="adventures-in-covariance.html#cb1206-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb1206-8"><a href="adventures-in-covariance.html#cb1206-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1206-9"><a href="adventures-in-covariance.html#cb1206-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span><span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.5&quot;</span></span>
<span id="cb1206-10"><a href="adventures-in-covariance.html#cb1206-10" aria-hidden="true" tabindex="-1"></a>      )</span></code></pre></div>
結果は以下の通り（表<a href="adventures-in-covariance.html#tab:res-b14-5">14.3</a>）。DAGの通りQとEの間に関連が生じており、その結果Eの係数もさらに0から離れていることが分かる。<br />

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-5">表14.3: </span>b14.5の結果。
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_Intercept
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
-0.08
</td>
<td style="text-align:right;">
0.07
</td>
</tr>
<tr>
<td style="text-align:left;">
b_e
</td>
<td style="text-align:right;">
0.64
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
0.55
</td>
<td style="text-align:right;">
0.73
</td>
</tr>
<tr>
<td style="text-align:left;">
b_q
</td>
<td style="text-align:right;">
-0.41
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
-0.50
</td>
<td style="text-align:right;">
-0.31
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma
</td>
<td style="text-align:right;">
0.86
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.80
</td>
<td style="text-align:right;">
0.91
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-1.78
</td>
<td style="text-align:right;">
0.18
</td>
<td style="text-align:right;">
-2.15
</td>
<td style="text-align:right;">
-1.46
</td>
</tr>
</tbody>
</table>
<p>Qを用いて正しい因果関係を推定するためには、以下のような多変量モデルを作成すればよい。このモデルではWとEの残差に相関がある可能性があることを示しており（これは、Uが交絡要因となっているため）、これが5章で扱ったモデルとは異なる。なお、Uを欠損値として代入する方法もあるが、それについては次の章で学ぶ。</p>
<p><span class="math display">\[
\begin{aligned}
  \begin{bmatrix}
    W_{i}\\E_{i}
  \end{bmatrix}
  &amp;\sim MVNorm(
  \begin{bmatrix}
    \mu_{W,i}\\
    \mu_{E,i}
  \end{bmatrix}
  , \mathbf{\sum})\\
  \mu_{W,i} &amp;= \alpha_{W} + \beta_{EW}E_{i}\\
  \mu_{E,i} &amp;= \alpha_{E} + \beta_{QW}Q_{i}\\
  \mathbf{\sigma} &amp;= \begin{bmatrix}
               \sigma_{W}&amp;0\\0&amp;\sigma_{E}
                      \end{bmatrix}
            \mathbf{R}
                     \begin{bmatrix}
               \sigma_{W}&amp;0\\0&amp;\sigma_{E}
                     \end{bmatrix}\\
  \mathbf{R} &amp;= \begin{bmatrix}
                  1&amp;\rho\\ \rho&amp;1
                \end{bmatrix}\\
  \alpha_{W}, \alpha_{E} &amp;\sim Normal(0,0.2)\\
  \beta_{EW}. \beta_{QE} &amp;\sim Normal(0,0.5)\\
  \sigma_{W}, \sigma_{W} &amp;\sim Exponential(1)\\
  \rho &amp;\sim LKJcorr(2)
\end{aligned}
\]</span>
<br /></p>
<p><code>brms</code>でモデリングする。</p>
<div class="sourceCode" id="cb1207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1207-1"><a href="adventures-in-covariance.html#cb1207-1" aria-hidden="true" tabindex="-1"></a>e_model <span class="ot">&lt;-</span> <span class="fu">bf</span>(e <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>q)</span>
<span id="cb1207-2"><a href="adventures-in-covariance.html#cb1207-2" aria-hidden="true" tabindex="-1"></a>w_model <span class="ot">&lt;-</span> <span class="fu">bf</span>(w <span class="sc">~</span> <span class="dv">1</span><span class="sc">+</span>e)</span>
<span id="cb1207-3"><a href="adventures-in-covariance.html#cb1207-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1207-4"><a href="adventures-in-covariance.html#cb1207-4" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.6</span> <span class="ot">&lt;-</span> </span>
<span id="cb1207-5"><a href="adventures-in-covariance.html#cb1207-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span> dat_sim,</span>
<span id="cb1207-6"><a href="adventures-in-covariance.html#cb1207-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1207-7"><a href="adventures-in-covariance.html#cb1207-7" aria-hidden="true" tabindex="-1"></a>      e_model <span class="sc">+</span> w_model <span class="sc">+</span> <span class="fu">set_rescor</span>(<span class="cn">TRUE</span>),</span>
<span id="cb1207-8"><a href="adventures-in-covariance.html#cb1207-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="at">class =</span> Intercept,<span class="at">resp =</span> e),</span>
<span id="cb1207-9"><a href="adventures-in-covariance.html#cb1207-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">class =</span> b, <span class="at">resp =</span> e),</span>
<span id="cb1207-10"><a href="adventures-in-covariance.html#cb1207-10" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma, <span class="at">resp =</span> e),</span>
<span id="cb1207-11"><a href="adventures-in-covariance.html#cb1207-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="at">class =</span> Intercept,<span class="at">resp =</span> w),</span>
<span id="cb1207-12"><a href="adventures-in-covariance.html#cb1207-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">class =</span> b, <span class="at">resp =</span> w),</span>
<span id="cb1207-13"><a href="adventures-in-covariance.html#cb1207-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma, <span class="at">resp =</span> w),</span>
<span id="cb1207-14"><a href="adventures-in-covariance.html#cb1207-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">2</span>), <span class="at">class =</span> rescor)),</span>
<span id="cb1207-15"><a href="adventures-in-covariance.html#cb1207-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1207-16"><a href="adventures-in-covariance.html#cb1207-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.6&quot;</span>)</span></code></pre></div>
結果は以下の通り（表<a href="adventures-in-covariance.html#tab:res-b14-6">14.4</a>）。うまく推定が行えていることが分かる。誤差間の相関（rescor）が大きいことは、 EとWが共通の要因から影響を受けていることを強く示唆している。<br />

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-6">表14.4: </span>b14.6の結果
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_e_Intercept
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
-0.07
</td>
<td style="text-align:right;">
0.07
</td>
</tr>
<tr>
<td style="text-align:left;">
b_w_Intercept
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
-0.09
</td>
<td style="text-align:right;">
0.09
</td>
</tr>
<tr>
<td style="text-align:left;">
b_e_q
</td>
<td style="text-align:right;">
0.59
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.52
</td>
<td style="text-align:right;">
0.66
</td>
</tr>
<tr>
<td style="text-align:left;">
b_w_e
</td>
<td style="text-align:right;">
-0.05
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
-0.20
</td>
<td style="text-align:right;">
0.10
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_e
</td>
<td style="text-align:right;">
0.81
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
0.76
</td>
<td style="text-align:right;">
0.86
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_w
</td>
<td style="text-align:right;">
1.02
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
0.94
</td>
<td style="text-align:right;">
1.12
</td>
</tr>
<tr>
<td style="text-align:left;">
rescor__e__w
</td>
<td style="text-align:right;">
0.54
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
0.43
</td>
<td style="text-align:right;">
0.64
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-2.29
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
-2.59
</td>
<td style="text-align:right;">
-2.04
</td>
</tr>
</tbody>
</table>
<p>それでは、今度は教育による効果があるというデータをシミュレートする。</p>
<div class="sourceCode" id="cb1208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1208-1"><a href="adventures-in-covariance.html#cb1208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">73</span>)</span>
<span id="cb1208-2"><a href="adventures-in-covariance.html#cb1208-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb1208-3"><a href="adventures-in-covariance.html#cb1208-3" aria-hidden="true" tabindex="-1"></a>dat_sim2 <span class="ot">&lt;-</span> </span>
<span id="cb1208-4"><a href="adventures-in-covariance.html#cb1208-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">u_sim =</span> <span class="fu">rnorm</span>(n,<span class="at">mean=</span><span class="dv">0</span>,<span class="at">sd=</span><span class="dv">1</span>),</span>
<span id="cb1208-5"><a href="adventures-in-covariance.html#cb1208-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">q_sim =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">size=</span>n, <span class="at">replace=</span><span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1208-6"><a href="adventures-in-covariance.html#cb1208-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">e_sim =</span> <span class="fu">rnorm</span>(n, <span class="at">mean=</span>u_sim <span class="sc">+</span> q_sim, <span class="at">sd=</span><span class="dv">1</span>),</span>
<span id="cb1208-7"><a href="adventures-in-covariance.html#cb1208-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">w_sim =</span> <span class="fu">rnorm</span>(n, <span class="at">mean=</span><span class="sc">-</span>u_sim <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>e_sim, <span class="at">sd =</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1208-8"><a href="adventures-in-covariance.html#cb1208-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> <span class="fu">standardize</span>(w_sim),</span>
<span id="cb1208-9"><a href="adventures-in-covariance.html#cb1208-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">e =</span> <span class="fu">standardize</span>(e_sim),</span>
<span id="cb1208-10"><a href="adventures-in-covariance.html#cb1208-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">q =</span> <span class="fu">standardize</span>(q_sim))</span>
<span id="cb1208-11"><a href="adventures-in-covariance.html#cb1208-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1208-12"><a href="adventures-in-covariance.html#cb1208-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat_sim2)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 7
##     u_sim q_sim e_sim  w_sim w           e           q         
##     &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dw_trnsf&gt;  &lt;dw_trnsf&gt;  &lt;dw_trnsf&gt;
## 1 -0.145      1 1.51   0.809  0.24777771 -0.57472658 -1.3562176
## 2  0.291      1 0.664  0.396 -0.05626233 -1.08822480 -1.3562176
## 3  0.0938     3 2.44  -0.364 -0.61500793 -0.01850495  0.4282792
## 4 -0.127      3 4.09   0.347 -0.09215742  0.97829629  0.4282792
## 5 -0.847      4 2.62   0.976  0.37002007  0.09392642  1.3205276
## 6  0.141      4 3.54   0.357 -0.08516221  0.65088153  1.3205276</code></pre>
<p>それでは、同様に3つのモデリングを行う。</p>
<div class="sourceCode" id="cb1210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1210-1"><a href="adventures-in-covariance.html#cb1210-1" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.4</span>x <span class="ot">&lt;-</span> <span class="fu">update</span>(b14<span class="fl">.4</span>,</span>
<span id="cb1210-2"><a href="adventures-in-covariance.html#cb1210-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">newdata =</span> dat_sim2,</span>
<span id="cb1210-3"><a href="adventures-in-covariance.html#cb1210-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span><span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.4x&quot;</span>)</span>
<span id="cb1210-4"><a href="adventures-in-covariance.html#cb1210-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1210-5"><a href="adventures-in-covariance.html#cb1210-5" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.5</span>x <span class="ot">&lt;-</span> <span class="fu">update</span>(b14<span class="fl">.5</span>,</span>
<span id="cb1210-6"><a href="adventures-in-covariance.html#cb1210-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">newdata =</span> dat_sim2,</span>
<span id="cb1210-7"><a href="adventures-in-covariance.html#cb1210-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span><span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.5x&quot;</span>)</span>
<span id="cb1210-8"><a href="adventures-in-covariance.html#cb1210-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1210-9"><a href="adventures-in-covariance.html#cb1210-9" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.6</span>x <span class="ot">&lt;-</span> <span class="fu">update</span>(b14<span class="fl">.6</span>,</span>
<span id="cb1210-10"><a href="adventures-in-covariance.html#cb1210-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">newdata =</span> dat_sim2,</span>
<span id="cb1210-11"><a href="adventures-in-covariance.html#cb1210-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span><span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.6x&quot;</span>)</span></code></pre></div>
<p>推定値を図示すると以下のようになる。やはり3つめのモデルでうまく推定ができたことが分かる。また、EとQの残差の相関は負になっている。これは、UがWには正に影響し、Eには負に影響していたからである。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-691-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><code>dagitty</code>パッケージにはDAG内で<em>instrumental variable</em>があるか判定してくれる関数が存在する。</p>
<div class="sourceCode" id="cb1211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1211-1"><a href="adventures-in-covariance.html#cb1211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb1211-2"><a href="adventures-in-covariance.html#cb1211-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1211-3"><a href="adventures-in-covariance.html#cb1211-3" aria-hidden="true" tabindex="-1"></a>dagIV <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(<span class="st">&quot;dag{Q -&gt; E &lt;- U -&gt; W &lt;- E}&quot;</span>)</span>
<span id="cb1211-4"><a href="adventures-in-covariance.html#cb1211-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1211-5"><a href="adventures-in-covariance.html#cb1211-5" aria-hidden="true" tabindex="-1"></a><span class="fu">instrumentalVariables</span>(dagIV, <span class="at">exposure =</span> <span class="st">&quot;E&quot;</span>, <span class="at">outcome =</span> <span class="st">&quot;W&quot;</span>)</span></code></pre></div>
<pre><code>##  Q</code></pre>
<p>現実的にはある変数が<em>instrumental variable</em>かを判断することは難しい。背景となる科学的な知識に基づいて判断することが重要である。</p>
</div>
<div id="other-designs" class="section level3 hasAnchor" number="14.3.2">
<h3><span class="header-section-number">14.3.2</span> Other designs<a href="adventures-in-covariance.html#other-designs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="front-door-criterion" class="section level4 hasAnchor" number="14.3.2.1">
<h4><span class="header-section-number">14.3.2.1</span> Front door criterion<a href="adventures-in-covariance.html#front-door-criterion" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>以下のようなDAGがあるとする。もしXとYの因果関係を調べたいとする。もし、Zが確実にYに影響を与えているとすれば、フロントドア基準が用いて因果関係を推定することができる。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-693-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>例として、大学で形成された社会的紐帯と上院における投票行動の関連を分析した研究がある<span class="citation">(<a href="#ref-Cohen2014" role="doc-biblioref">Cohen and Malloy 2014</a>)</span>。上院では隣の座席になった人同士で同じような投票行動をとる可能性が高いと考えられるが、席順はランダムに割り振られる。よって、席順と出身大学は同じ要因から影響を受けていないといえる。よって、もし座席が隣同士でかつ同じ出身大学の人が座席が隣でかつ同じ出身大学でない人よりも同じような投票行動をするとき、出身大学が同じであることが投票行動に影響しているということができる。</p>
</div>
<div id="regression-discontinuity" class="section level4 hasAnchor" number="14.3.2.2">
<h4><span class="header-section-number">14.3.2.2</span> Regression discontinuity<a href="adventures-in-covariance.html#regression-discontinuity" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>回帰分断デザインについては、他の本参照。</p>
</div>
</div>
</div>
<div id="social-relations-as-correlated-varying-effects" class="section level2 hasAnchor" number="14.4">
<h2><span class="header-section-number">14.4</span> Social relations as correlated varying effects<a href="adventures-in-covariance.html#social-relations-as-correlated-varying-effects" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>ニカラグアの家庭間での贈り物の交換に関するデータを扱う<span class="citation">(<a href="#ref-Koster2014" role="doc-biblioref">Koster and Leckie 2014</a>)</span>。</p>
<div class="sourceCode" id="cb1213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1213-1"><a href="adventures-in-covariance.html#cb1213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;KosterLeckie&quot;</span>)</span>
<span id="cb1213-2"><a href="adventures-in-covariance.html#cb1213-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1213-3"><a href="adventures-in-covariance.html#cb1213-3" aria-hidden="true" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> kl_dyads</span>
<span id="cb1213-4"><a href="adventures-in-covariance.html#cb1213-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(kl_dyads) <span class="sc">%&gt;%</span> </span>
<span id="cb1213-5"><a href="adventures-in-covariance.html#cb1213-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1213-6"><a href="adventures-in-covariance.html#cb1213-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">&quot;hold_position&quot;</span>,<span class="st">&quot;striped&quot;</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
hidA
</th>
<th style="text-align:right;">
hidB
</th>
<th style="text-align:right;">
did
</th>
<th style="text-align:right;">
giftsAB
</th>
<th style="text-align:right;">
giftsBA
</th>
<th style="text-align:right;">
offset
</th>
<th style="text-align:right;">
drel1
</th>
<th style="text-align:right;">
drel2
</th>
<th style="text-align:right;">
drel3
</th>
<th style="text-align:right;">
drel4
</th>
<th style="text-align:right;">
dlndist
</th>
<th style="text-align:right;">
dass
</th>
<th style="text-align:right;">
d0125
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-2.790
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
31
</td>
<td style="text-align:right;">
-0.003
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-2.817
</td>
<td style="text-align:right;">
0.044
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
-0.019
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-1.886
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-1.892
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
-0.003
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-3.499
</td>
<td style="text-align:right;">
0.022
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-1.853
</td>
<td style="text-align:right;">
0.071
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p>下図は、家庭AとBの間の贈り物の数をプロットしたもの。相関は0.24と高くないが、それだけで家庭間の交換でバランスが取れていないと判断するべきではない。なぜなら、他家庭に送るプレゼントの量は各家庭の経済状況などに依存するため、これらの影響を切り離す必要があるからである。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-695-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>そこで、以下のモデルを考える。なお、<span class="math inline">\(g_{A}\)</span>は家庭Aの贈り物を送る傾向を表すランダム効果、<span class="math inline">\(r_B\)</span>は家庭Bが贈り物を受ける傾向を示すランダム効果、<span class="math inline">\(d_{AB}\)</span>は各ダイアッド間での贈り物の量のばらつきを表すランダム効果である。
<span class="math display">\[
\begin{aligned}
y_{A\to B} &amp;\sim Poisson(\lambda_{AB})\\
log\lambda_{AB} &amp;= \alpha + g_{A} + r_{B} + d_{AB}\\
\end{aligned}
\]</span>
<br/></p>
<p>家庭Bに対する贈り物についても同様。<br />
<span class="math display">\[
\begin{aligned}
y_{B\to A} &amp;\sim Poisson(\lambda_{BA})\\
log\lambda_{BA} &amp;= \alpha + g_{B} + r_{A} + d_{BA}\\
\end{aligned}
\]</span>
<br /></p>
<p>また、<span class="math inline">\(g\)</span>と<span class="math inline">\(r\)</span>、<span class="math inline">\(d_{AB}\)</span>と<span class="math inline">\(d_{BA}\)</span>の間には相関があると想定できるので、以下のようにモデリングする。</p>
<p><span class="math display">\[
\begin{aligned}
  \begin{pmatrix}
    g_{i}\\r_{i}
  \end{pmatrix}
  &amp;\sim
  MVNormal
    \begin{pmatrix}
        \begin{pmatrix}
          0\\0
        \end{pmatrix},
        \begin{pmatrix}
          \sigma^2_{g} &amp; \sigma_{g}\sigma_{r}\rho_{gr}\\
          \sigma_{g}\sigma_{r}\rho_{gr} &amp; \sigma^2_{r}
        \end{pmatrix}
    \end{pmatrix}\\
  \begin{pmatrix}
    d_{ij}\\d_{ji}
  \end{pmatrix}
  &amp;\sim
  MVNormal
    \begin{pmatrix}
        \begin{pmatrix}
          0\\0
        \end{pmatrix},
        \begin{pmatrix}
          \sigma^2_{d} &amp; \sigma^2_{d}\rho_{d}\\
          \sigma^2_{d}\rho_{d} &amp; \sigma^2_{d}
        \end{pmatrix}
    \end{pmatrix}
\end{aligned}
\]</span>
<br /></p>
<p>それでは、モデリングを行う。<code>brms</code>パッケージではこのモデルを記述できないため、ここでは<code>rethinking</code>パッケージを用いる。</p>
<div class="sourceCode" id="cb1214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1214-1"><a href="adventures-in-covariance.html#cb1214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># kl_data &lt;- </span></span>
<span id="cb1214-2"><a href="adventures-in-covariance.html#cb1214-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   list(</span></span>
<span id="cb1214-3"><a href="adventures-in-covariance.html#cb1214-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     N            = nrow(kl_dyads),</span></span>
<span id="cb1214-4"><a href="adventures-in-covariance.html#cb1214-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     N_households = max(kl_dyads$hidB), </span></span>
<span id="cb1214-5"><a href="adventures-in-covariance.html#cb1214-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     did          = kl_dyads$did,</span></span>
<span id="cb1214-6"><a href="adventures-in-covariance.html#cb1214-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     hidA         = kl_dyads$hidA,</span></span>
<span id="cb1214-7"><a href="adventures-in-covariance.html#cb1214-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     hidB         = kl_dyads$hidB,</span></span>
<span id="cb1214-8"><a href="adventures-in-covariance.html#cb1214-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     giftsAB      = kl_dyads$giftsAB, </span></span>
<span id="cb1214-9"><a href="adventures-in-covariance.html#cb1214-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     giftsBA      = kl_dyads$giftsBA</span></span>
<span id="cb1214-10"><a href="adventures-in-covariance.html#cb1214-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb1214-11"><a href="adventures-in-covariance.html#cb1214-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1214-12"><a href="adventures-in-covariance.html#cb1214-12" aria-hidden="true" tabindex="-1"></a><span class="co"># m14.7 &lt;- </span></span>
<span id="cb1214-13"><a href="adventures-in-covariance.html#cb1214-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   ulam( </span></span>
<span id="cb1214-14"><a href="adventures-in-covariance.html#cb1214-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     alist(</span></span>
<span id="cb1214-15"><a href="adventures-in-covariance.html#cb1214-15" aria-hidden="true" tabindex="-1"></a><span class="co">#       giftsAB ~ poisson(lambdaAB),</span></span>
<span id="cb1214-16"><a href="adventures-in-covariance.html#cb1214-16" aria-hidden="true" tabindex="-1"></a><span class="co">#       giftsBA ~ poisson(lambdaBA),</span></span>
<span id="cb1214-17"><a href="adventures-in-covariance.html#cb1214-17" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1214-18"><a href="adventures-in-covariance.html#cb1214-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     log(lambdaAB) &lt;- a + gr[hidA, 1] + gr[hidB, 2] + d[did, 1] ,</span></span>
<span id="cb1214-19"><a href="adventures-in-covariance.html#cb1214-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     log(lambdaBA) &lt;- a + gr[hidB, 1] + gr[hidA, 2] + d[did, 2] ,</span></span>
<span id="cb1214-20"><a href="adventures-in-covariance.html#cb1214-20" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1214-21"><a href="adventures-in-covariance.html#cb1214-21" aria-hidden="true" tabindex="-1"></a><span class="co">#       a ~ normal(0, 1),</span></span>
<span id="cb1214-22"><a href="adventures-in-covariance.html#cb1214-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1214-23"><a href="adventures-in-covariance.html#cb1214-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     vector[2]:gr[N_households]~multi_normal(0,Rho_gr,sigma_gr),</span></span>
<span id="cb1214-24"><a href="adventures-in-covariance.html#cb1214-24" aria-hidden="true" tabindex="-1"></a><span class="co">#       Rho_gr ~ lkj_corr(4),</span></span>
<span id="cb1214-25"><a href="adventures-in-covariance.html#cb1214-25" aria-hidden="true" tabindex="-1"></a><span class="co">#       sigma_gr ~ exponential(1),</span></span>
<span id="cb1214-26"><a href="adventures-in-covariance.html#cb1214-26" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb1214-27"><a href="adventures-in-covariance.html#cb1214-27" aria-hidden="true" tabindex="-1"></a><span class="co">#       transpars&gt; matrix[N,2]:d &lt;-</span></span>
<span id="cb1214-28"><a href="adventures-in-covariance.html#cb1214-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         compose_noncentered(rep_vector(sigma_d, 2), L_Rho_d, z),</span></span>
<span id="cb1214-29"><a href="adventures-in-covariance.html#cb1214-29" aria-hidden="true" tabindex="-1"></a><span class="co">#       matrix[2,N]:z ~ normal(0, 1),</span></span>
<span id="cb1214-30"><a href="adventures-in-covariance.html#cb1214-30" aria-hidden="true" tabindex="-1"></a><span class="co">#       cholesky_factor_corr[2]:L_Rho_d ~ lkj_corr_cholesky(8),</span></span>
<span id="cb1214-31"><a href="adventures-in-covariance.html#cb1214-31" aria-hidden="true" tabindex="-1"></a><span class="co">#       sigma_d ~ exponential(1),</span></span>
<span id="cb1214-32"><a href="adventures-in-covariance.html#cb1214-32" aria-hidden="true" tabindex="-1"></a><span class="co">#     gq&gt; matrix[2, 2]:Rho_d &lt;&lt;- Chol_to_Corr(L_Rho_d)</span></span>
<span id="cb1214-33"><a href="adventures-in-covariance.html#cb1214-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     ),</span></span>
<span id="cb1214-34"><a href="adventures-in-covariance.html#cb1214-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     data = kl_data,</span></span>
<span id="cb1214-35"><a href="adventures-in-covariance.html#cb1214-35" aria-hidden="true" tabindex="-1"></a><span class="co">#     chains = 4, cores = 4, iter = 2000</span></span>
<span id="cb1214-36"><a href="adventures-in-covariance.html#cb1214-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb1214-37"><a href="adventures-in-covariance.html#cb1214-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1214-38"><a href="adventures-in-covariance.html#cb1214-38" aria-hidden="true" tabindex="-1"></a>m14<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;output/Chapter14/m14.7.rds&quot;</span>)</span></code></pre></div>
<span class="math inline">\(\rho_{gr}\)</span>と<span class="math inline">\(\sigma^2_{g}\)</span>、<span class="math inline">\(\sigma^2_{r}\)</span>の推定値は以下の通り（表<a href="adventures-in-covariance.html#tab:res-m14-7">14.5</a>）。結果、多くの贈り物をする人は、あまり贈り物をもらわない傾向にあることが分かった。また、受け取る量よりも受け取る量のばらつきの方が大きい。<br />

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-m14-7">表14.5: </span>m14.7の結果
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
X5.5.
</th>
<th style="text-align:right;">
X94.5.
</th>
<th style="text-align:right;">
n_eff
</th>
<th style="text-align:right;">
Rhat4
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Rho_gr[1,1]
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
NaN
</td>
<td style="text-align:right;">
NaN
</td>
</tr>
<tr>
<td style="text-align:left;">
Rho_gr[1,2]
</td>
<td style="text-align:right;">
-0.41
</td>
<td style="text-align:right;">
0.20
</td>
<td style="text-align:right;">
-0.71
</td>
<td style="text-align:right;">
-0.05
</td>
<td style="text-align:right;">
1127.75
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Rho_gr[2,1]
</td>
<td style="text-align:right;">
-0.41
</td>
<td style="text-align:right;">
0.20
</td>
<td style="text-align:right;">
-0.71
</td>
<td style="text-align:right;">
-0.05
</td>
<td style="text-align:right;">
1127.75
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Rho_gr[2,2]
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
3920.71
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_gr[1]
</td>
<td style="text-align:right;">
0.84
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
0.64
</td>
<td style="text-align:right;">
1.08
</td>
<td style="text-align:right;">
2320.01
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_gr[2]
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.09
</td>
<td style="text-align:right;">
0.29
</td>
<td style="text-align:right;">
0.58
</td>
<td style="text-align:right;">
1181.81
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p>各家庭の事後平均を示したのが下図である。楕円は、50%信用区間を表す。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-697-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><span class="math inline">\(\sigma^2_{d}\)</span>と<span class="math inline">\(\rho_{d}\)</span>の推定値は以下の通り（表<a href="adventures-in-covariance.html#tab:res-m14-7-2">14.6</a>）。</p>
<div class="sourceCode" id="cb1215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1215-1"><a href="adventures-in-covariance.html#cb1215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m14<span class="fl">.7</span>, <span class="at">depth =</span> <span class="dv">3</span>, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;Rho_d&quot;</span>, <span class="st">&quot;sigma_d&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1215-2"><a href="adventures-in-covariance.html#cb1215-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1215-3"><a href="adventures-in-covariance.html#cb1215-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;par&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1215-4"><a href="adventures-in-covariance.html#cb1215-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span>T,</span>
<span id="cb1215-5"><a href="adventures-in-covariance.html#cb1215-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits=</span><span class="dv">2</span>,</span>
<span id="cb1215-6"><a href="adventures-in-covariance.html#cb1215-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption  =</span> <span class="st">&quot;m14.7の結果2 &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1215-7"><a href="adventures-in-covariance.html#cb1215-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">&quot;striped&quot;</span>,<span class="st">&quot;hold_position&quot;</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-m14-7-2">表14.6: </span>m14.7の結果2
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
X5.5.
</th>
<th style="text-align:right;">
X94.5.
</th>
<th style="text-align:right;">
n_eff
</th>
<th style="text-align:right;">
Rhat4
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Rho_d[1,1]
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
NaN
</td>
<td style="text-align:right;">
NaN
</td>
</tr>
<tr>
<td style="text-align:left;">
Rho_d[1,2]
</td>
<td style="text-align:right;">
0.88
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.82
</td>
<td style="text-align:right;">
0.93
</td>
<td style="text-align:right;">
1012.29
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Rho_d[2,1]
</td>
<td style="text-align:right;">
0.88
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.82
</td>
<td style="text-align:right;">
0.93
</td>
<td style="text-align:right;">
1012.29
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Rho_d[2,2]
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
NaN
</td>
<td style="text-align:right;">
NaN
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma_d
</td>
<td style="text-align:right;">
1.10
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
1.02
</td>
<td style="text-align:right;">
1.19
</td>
<td style="text-align:right;">
1283.94
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p>下図は、事後平均をプロットしたものである。<span class="math inline">\(d_{ij}\)</span>と<span class="math inline">\(d_{ji}\)</span>の間には強い相関があることが分かる。すなわち、家庭間の贈与量はバランスが取れている（家庭AがBにあげる量が少なければ、BがAにあげる量も少ない）。また、ダイアッド間でばらつきが大きいことも分かる。この結果は、互恵性が成立していることを示している。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-698-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="continuous-categories-and-the-gaussian-process" class="section level2 hasAnchor" number="14.5">
<h2><span class="header-section-number">14.5</span> Continuous categories and the Gaussian process<a href="adventures-in-covariance.html#continuous-categories-and-the-gaussian-process" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>ここまでは、ランダム効果は順序のない、不連続なカテゴリーに対して適応されていた。もし、連続的なカテゴリー（年齢、身長、収入など）をランダム効果に組み込む場合にはどうすればよいだろうか？<br />
このような場合に用いることができるのがガウス過程回帰（<strong>Gaussian process regression</strong>）である。</p>
<div id="example-spatial-autocorrelation-in-oceanic-tools" class="section level3 hasAnchor" number="14.5.1">
<h3><span class="header-section-number">14.5.1</span> Example: Spatial autocorrelation in Oceanic tools<a href="adventures-in-covariance.html#example-spatial-autocorrelation-in-oceanic-tools" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>11章でオセアニア諸国の道具数についてモデリングを行ったとき、他国との交渉頻度を低いか高いかの2カテゴリーに分類した。しかし、このモデルでは、交渉相手国がどの国なのか（小さい国なのか大きい国なのか）が考慮されていない。また、道具が各国間で交換されているのであれば、各国の道具数は独立ではないという問題点もある。また、各国の地理的距離（近い国ほど同じような素材がある）も考慮する必要がある。
以上から、各国間の地理的距離を考慮したモデルを考える必要がある。<strong>ガウス過程モデル</strong>ではモデルに各国の距離マトリックスを組み込むことでこれを実現する。</p>
<div class="sourceCode" id="cb1216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1216-1"><a href="adventures-in-covariance.html#cb1216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;islandsDistMatrix&quot;</span>)</span>
<span id="cb1216-2"><a href="adventures-in-covariance.html#cb1216-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1216-3"><a href="adventures-in-covariance.html#cb1216-3" aria-hidden="true" tabindex="-1"></a>d_mat <span class="ot">&lt;-</span> islandsDistMatrix</span>
<span id="cb1216-4"><a href="adventures-in-covariance.html#cb1216-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(d_mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Ml&quot;</span>, <span class="st">&quot;Ti&quot;</span>, <span class="st">&quot;SC&quot;</span>, <span class="st">&quot;Ya&quot;</span>, <span class="st">&quot;Fi&quot;</span>, <span class="st">&quot;Tr&quot;</span>, <span class="st">&quot;Ch&quot;</span>, <span class="st">&quot;Mn&quot;</span>, <span class="st">&quot;To&quot;</span>, <span class="st">&quot;Ha&quot;</span>)</span></code></pre></div>
<p>各国間の距離は以下の通り。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-700-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>モデル式は以下の通り。距離マトリックスをランダム切片に加える。
<span class="math display">\[
\begin{aligned}
  T_{i} &amp;\sim Poisson(\lambda_{i})\\
  \lambda_{i} &amp;= exp(k_{society[i]})\alpha P^{\beta}_{i}/ \gamma\\
  \begin{pmatrix}
    k_{1}\\k_{2}\\k_{3}\\...\\k_{10}
  \end{pmatrix}
    &amp;\sim Normal
  \begin{pmatrix}
      \begin{pmatrix}
          0\\0\\0\\...\\0
      \end{pmatrix},
          \mathbf{K}
  \end{pmatrix}\\
  \mathbf{K_{ij}} &amp;= \eta^2 exp(\rho^2D^2_{ij}) + \delta_{ij}\sigma^2\\
\end{aligned}
\]</span>
<br /></p>
<p>なお、<span class="math inline">\(K_{ij}\)</span>は国<span class="math inline">\(i\)</span>と国<span class="math inline">\(j\)</span>の共分散を表す。<span class="math inline">\(D_{ij}\)</span>は国間の距離なので、<span class="math inline">\(K_{ij}\)</span>は国家間の距離の二乗が大きくなるほど共分散は小さくなる。<span class="math inline">\(\rho\)</span>はこの減少の速度を表す。距離の二乗を用いたのは、それが実際の共分散の減少をよりよく表していると考えられるためである。下図は、<span class="math inline">\(D_{ij}\)</span>に応じて<span class="math inline">\(K_ij\)</span>がどのように変化するかを示したものである。</p>
<p><img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-701-1.png" width="672" style="display: block; margin: auto;" />
<br /></p>
<p><span class="math inline">\(\eta^2\)</span>は最大の共分散を、<span class="math inline">\(\delta_{ij}\sigma^2\)</span>は<span class="math inline">\(i =j\)</span>のときの共分散の追加分を示す。<span class="math inline">\(\delta_{ij}\)</span>は<span class="math inline">\(i=j\)</span>のときに1、それ以外のときに0をとる関数で、<span class="math inline">\(\sigma\)</span>は国内のばらつきを示す。今回は各国につき1つしかデータがないので関係ない。<span class="math inline">\(\eta^2\)</span>と<span class="math inline">\(\rho^2\)</span>の事前分布を以下のとおりとする。</p>
<p><span class="math display">\[
\begin{aligned}
  \eta^2 &amp;\sim Exponential(2)\\
  \rho^2 &amp;\sim Exponential(0.5)
\end{aligned}
\]</span>
<br /></p>
<p><code>brms</code>パッケージでは、<code>gp()</code>を用いることでガウス過程を扱うことができる。この関数内では、各国の緯度と経度を用いて<span class="math inline">\(D_{ij}\)</span>を算出する。<code>scale = TRUE</code>は<span class="math inline">\(D_{ij}\)</span>の最大値を1とする。今回は<code>FALSE</code>にする。データ上の緯度と経度は十進角（decimal degree）で記されているのでkmに直すために0.11132をかける。</p>
<div class="sourceCode" id="cb1217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1217-1"><a href="adventures-in-covariance.html#cb1217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;Kline2&quot;</span>)</span>
<span id="cb1217-2"><a href="adventures-in-covariance.html#cb1217-2" aria-hidden="true" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> Kline2 <span class="sc">%&gt;%</span> </span>
<span id="cb1217-3"><a href="adventures-in-covariance.html#cb1217-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lat_adj =</span> lat<span class="sc">*</span><span class="fl">0.11132</span>,</span>
<span id="cb1217-4"><a href="adventures-in-covariance.html#cb1217-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">lon2_adj =</span> lon2<span class="sc">*</span><span class="fl">0.11132</span>)</span>
<span id="cb1217-5"><a href="adventures-in-covariance.html#cb1217-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1217-6"><a href="adventures-in-covariance.html#cb1217-6" aria-hidden="true" tabindex="-1"></a>d4 <span class="sc">%&gt;%</span> </span>
<span id="cb1217-7"><a href="adventures-in-covariance.html#cb1217-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(culture, lat, lon2, lat_adj<span class="sc">:</span>lon2_adj) <span class="sc">%&gt;%</span> </span>
<span id="cb1217-8"><a href="adventures-in-covariance.html#cb1217-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1217-9"><a href="adventures-in-covariance.html#cb1217-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits =</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1217-10"><a href="adventures-in-covariance.html#cb1217-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">&quot;striped&quot;</span>)</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
culture
</th>
<th style="text-align:right;">
lat
</th>
<th style="text-align:right;">
lon2
</th>
<th style="text-align:right;">
lat_adj
</th>
<th style="text-align:right;">
lon2_adj
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Malekula
</td>
<td style="text-align:right;">
-16.3
</td>
<td style="text-align:right;">
-12.5
</td>
<td style="text-align:right;">
-1.81
</td>
<td style="text-align:right;">
-1.39
</td>
</tr>
<tr>
<td style="text-align:left;">
Tikopia
</td>
<td style="text-align:right;">
-12.3
</td>
<td style="text-align:right;">
-11.2
</td>
<td style="text-align:right;">
-1.37
</td>
<td style="text-align:right;">
-1.25
</td>
</tr>
<tr>
<td style="text-align:left;">
Santa Cruz
</td>
<td style="text-align:right;">
-10.7
</td>
<td style="text-align:right;">
-14.0
</td>
<td style="text-align:right;">
-1.19
</td>
<td style="text-align:right;">
-1.56
</td>
</tr>
<tr>
<td style="text-align:left;">
Yap
</td>
<td style="text-align:right;">
9.5
</td>
<td style="text-align:right;">
-41.9
</td>
<td style="text-align:right;">
1.06
</td>
<td style="text-align:right;">
-4.66
</td>
</tr>
<tr>
<td style="text-align:left;">
Lau Fiji
</td>
<td style="text-align:right;">
-17.7
</td>
<td style="text-align:right;">
-1.9
</td>
<td style="text-align:right;">
-1.97
</td>
<td style="text-align:right;">
-0.21
</td>
</tr>
<tr>
<td style="text-align:left;">
Trobriand
</td>
<td style="text-align:right;">
-8.7
</td>
<td style="text-align:right;">
-29.1
</td>
<td style="text-align:right;">
-0.97
</td>
<td style="text-align:right;">
-3.24
</td>
</tr>
<tr>
<td style="text-align:left;">
Chuuk
</td>
<td style="text-align:right;">
7.4
</td>
<td style="text-align:right;">
-28.4
</td>
<td style="text-align:right;">
0.82
</td>
<td style="text-align:right;">
-3.16
</td>
</tr>
<tr>
<td style="text-align:left;">
Manus
</td>
<td style="text-align:right;">
-2.1
</td>
<td style="text-align:right;">
-33.1
</td>
<td style="text-align:right;">
-0.23
</td>
<td style="text-align:right;">
-3.68
</td>
</tr>
<tr>
<td style="text-align:left;">
Tonga
</td>
<td style="text-align:right;">
-21.2
</td>
<td style="text-align:right;">
4.8
</td>
<td style="text-align:right;">
-2.36
</td>
<td style="text-align:right;">
0.53
</td>
</tr>
<tr>
<td style="text-align:left;">
Hawaii
</td>
<td style="text-align:right;">
19.9
</td>
<td style="text-align:right;">
24.4
</td>
<td style="text-align:right;">
2.22
</td>
<td style="text-align:right;">
2.72
</td>
</tr>
</tbody>
</table>
<p>それでは、モデリングを行う。</p>
<div class="sourceCode" id="cb1218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1218-1"><a href="adventures-in-covariance.html#cb1218-1" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.8</span> <span class="ot">&lt;-</span> </span>
<span id="cb1218-2"><a href="adventures-in-covariance.html#cb1218-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span>d4,</span>
<span id="cb1218-3"><a href="adventures-in-covariance.html#cb1218-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">&quot;identity&quot;</span>),</span>
<span id="cb1218-4"><a href="adventures-in-covariance.html#cb1218-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bf</span>(total_tools <span class="sc">~</span> <span class="fu">exp</span>(a)<span class="sc">*</span>population<span class="sc">^</span>b<span class="sc">/</span>g,</span>
<span id="cb1218-5"><a href="adventures-in-covariance.html#cb1218-5" aria-hidden="true" tabindex="-1"></a>         a <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">gp</span>(lat_adj, lon2_adj, <span class="at">scale =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1218-6"><a href="adventures-in-covariance.html#cb1218-6" aria-hidden="true" tabindex="-1"></a>         b <span class="sc">+</span> g <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb1218-7"><a href="adventures-in-covariance.html#cb1218-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">nl =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1218-8"><a href="adventures-in-covariance.html#cb1218-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nlpar =</span> a),</span>
<span id="cb1218-9"><a href="adventures-in-covariance.html#cb1218-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">nlpar =</span> b, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb1218-10"><a href="adventures-in-covariance.html#cb1218-10" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">nlpar =</span> g, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb1218-11"><a href="adventures-in-covariance.html#cb1218-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">inv_gamma</span>(<span class="fl">2.874624</span>, <span class="fl">2.941204</span>), </span>
<span id="cb1218-12"><a href="adventures-in-covariance.html#cb1218-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">class =</span> lscale, </span>
<span id="cb1218-13"><a href="adventures-in-covariance.html#cb1218-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">coef =</span> gplat_adjlon2_adj, <span class="at">nlpar =</span> a),</span>
<span id="cb1218-14"><a href="adventures-in-covariance.html#cb1218-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">2</span>), <span class="at">class =</span> sdgp, </span>
<span id="cb1218-15"><a href="adventures-in-covariance.html#cb1218-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">coef =</span> gplat_adjlon2_adj, <span class="at">nlpar =</span> a)),</span>
<span id="cb1218-16"><a href="adventures-in-covariance.html#cb1218-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">iter =</span> <span class="dv">3000</span>, <span class="at">warmup =</span> <span class="dv">2000</span>, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb1218-17"><a href="adventures-in-covariance.html#cb1218-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">14</span>, <span class="at">sample_prior =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1218-18"><a href="adventures-in-covariance.html#cb1218-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1218-19"><a href="adventures-in-covariance.html#cb1218-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.8&quot;</span>)</span></code></pre></div>
結果は以下の通り（表<a href="adventures-in-covariance.html#tab:res-b14-8">14.7</a>）。地理的な情報を考慮しても、人口が道具数に影響を与えていることが示唆される。
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-8">表14.7: </span>b14.8の結果
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_a_Intercept
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
0.85
</td>
<td style="text-align:right;">
-1.32
</td>
<td style="text-align:right;">
1.97
</td>
</tr>
<tr>
<td style="text-align:left;">
b_b_Intercept
</td>
<td style="text-align:right;">
0.26
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
0.10
</td>
<td style="text-align:right;">
0.43
</td>
</tr>
<tr>
<td style="text-align:left;">
b_g_Intercept
</td>
<td style="text-align:right;">
0.68
</td>
<td style="text-align:right;">
0.66
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
2.45
</td>
</tr>
<tr>
<td style="text-align:left;">
sdgp_a_gplat_adjlon2_adj
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
0.97
</td>
</tr>
<tr>
<td style="text-align:left;">
lscale_a_gplat_adjlon2_adj
</td>
<td style="text-align:right;">
1.49
</td>
<td style="text-align:right;">
0.75
</td>
<td style="text-align:right;">
0.52
</td>
<td style="text-align:right;">
3.32
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[1]
</td>
<td style="text-align:right;">
-0.50
</td>
<td style="text-align:right;">
0.75
</td>
<td style="text-align:right;">
-2.04
</td>
<td style="text-align:right;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[2]
</td>
<td style="text-align:right;">
0.40
</td>
<td style="text-align:right;">
0.86
</td>
<td style="text-align:right;">
-1.30
</td>
<td style="text-align:right;">
2.07
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[3]
</td>
<td style="text-align:right;">
-0.61
</td>
<td style="text-align:right;">
0.75
</td>
<td style="text-align:right;">
-2.01
</td>
<td style="text-align:right;">
0.99
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[4]
</td>
<td style="text-align:right;">
0.98
</td>
<td style="text-align:right;">
0.67
</td>
<td style="text-align:right;">
-0.32
</td>
<td style="text-align:right;">
2.34
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[5]
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
0.70
</td>
<td style="text-align:right;">
-1.12
</td>
<td style="text-align:right;">
1.68
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[6]
</td>
<td style="text-align:right;">
-1.08
</td>
<td style="text-align:right;">
0.75
</td>
<td style="text-align:right;">
-2.52
</td>
<td style="text-align:right;">
0.38
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[7]
</td>
<td style="text-align:right;">
0.19
</td>
<td style="text-align:right;">
0.72
</td>
<td style="text-align:right;">
-1.31
</td>
<td style="text-align:right;">
1.55
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[8]
</td>
<td style="text-align:right;">
-0.24
</td>
<td style="text-align:right;">
0.88
</td>
<td style="text-align:right;">
-1.95
</td>
<td style="text-align:right;">
1.50
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[9]
</td>
<td style="text-align:right;">
0.47
</td>
<td style="text-align:right;">
0.89
</td>
<td style="text-align:right;">
-1.49
</td>
<td style="text-align:right;">
2.08
</td>
</tr>
<tr>
<td style="text-align:left;">
zgp_a_gplat_adjlon2_adj[10]
</td>
<td style="text-align:right;">
-0.42
</td>
<td style="text-align:right;">
0.79
</td>
<td style="text-align:right;">
-1.99
</td>
<td style="text-align:right;">
1.11
</td>
</tr>
<tr>
<td style="text-align:left;">
prior_b_a
</td>
<td style="text-align:right;">
-0.03
</td>
<td style="text-align:right;">
1.01
</td>
<td style="text-align:right;">
-2.00
</td>
<td style="text-align:right;">
2.03
</td>
</tr>
<tr>
<td style="text-align:left;">
prior_sdgp_a_gplat_adjlon2_adj
</td>
<td style="text-align:right;">
0.49
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
1.88
</td>
</tr>
<tr>
<td style="text-align:left;">
prior_lscale_a__1_gplat_adjlon2_adj
</td>
<td style="text-align:right;">
1.60
</td>
<td style="text-align:right;">
1.85
</td>
<td style="text-align:right;">
0.43
</td>
<td style="text-align:right;">
5.10
</td>
</tr>
<tr>
<td style="text-align:left;">
prior_b_b
</td>
<td style="text-align:right;">
0.98
</td>
<td style="text-align:right;">
0.97
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
3.51
</td>
</tr>
<tr>
<td style="text-align:left;">
prior_b_g
</td>
<td style="text-align:right;">
1.03
</td>
<td style="text-align:right;">
1.01
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
3.81
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-3.50
</td>
<td style="text-align:right;">
1.49
</td>
<td style="text-align:right;">
-7.28
</td>
<td style="text-align:right;">
-1.56
</td>
</tr>
<tr>
<td style="text-align:left;">
lp__
</td>
<td style="text-align:right;">
-51.39
</td>
<td style="text-align:right;">
3.28
</td>
<td style="text-align:right;">
-58.72
</td>
<td style="text-align:right;">
-46.10
</td>
</tr>
</tbody>
</table>
<p><code>b_a_Intercept</code>の推定値が教科書と異なるのは、パラメータ化の仕方が少し異なるためである。指数関数をとってやると教科書の値とほとんど同じになる（信用区間は少し違うが）。</p>
<div class="sourceCode" id="cb1219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1219-1"><a href="adventures-in-covariance.html#cb1219-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(b14<span class="fl">.8</span>, <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">055</span>,.<span class="dv">945</span>))[<span class="st">&quot;a_Intercept&quot;</span>,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">4</span>)] <span class="sc">%&gt;%</span> </span>
<span id="cb1219-2"><a href="adventures-in-covariance.html#cb1219-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>()</span></code></pre></div>
<pre><code>##  Estimate      Q5.5     Q94.5 
## 1.4385190 0.3661252 5.4049424</code></pre>
<p><code>brms</code>パッケージでは、ガウス過程は以下のようにパラメータ化を行う。<span class="math inline">\(k(x_{i},x_{j})\)</span>は教科書の<span class="math inline">\(\mathbf{K_{ij}}\)</span>であり、<span class="math inline">\(||x_{i}-x_{i}||^2\)</span>は<span class="math inline">\(D_{ij}^2\)</span>である。さらに、<span class="math inline">\(sdgp^2\)</span>は<span class="math inline">\(\eta^2\)</span>であり、<span class="math inline">\(\rho^2 = 1/(2lscale^2)\)</span>である。</p>
<p><span class="math display">\[
k(x_{i},x_{j}) = sdgp^2 exp(-||x_{i}-x_{i}||^2/(2lscale^2))
\]</span>
<br /></p>
<p><code>brms</code>では<span class="math inline">\(sdgp^2\)</span>ではなく<span class="math inline">\(sdgp\)</span>が、<span class="math inline">\(lscale^2\)</span>ではなく <span class="math inline">\(lscale\)</span>が推定される。これは、以下の変換によって教科書と同じパラメータの推定値が得られる。<span class="math inline">\(\eta\)</span>はほとんど同じ値だが、<span class="math inline">\(\rho\)</span>が大きく異なる。これは、教科書とは異なる事前分布を用いたため？</p>
<div class="sourceCode" id="cb1221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1221-1"><a href="adventures-in-covariance.html#cb1221-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span></span>
<span id="cb1221-2"><a href="adventures-in-covariance.html#cb1221-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">posterior_samples</span>(b14<span class="fl">.8</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1221-3"><a href="adventures-in-covariance.html#cb1221-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">etasq =</span> sdgp_a_gplat_adjlon2_adj<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb1221-4"><a href="adventures-in-covariance.html#cb1221-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">rhosq =</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> lscale_a_gplat_adjlon2_adj<span class="sc">^</span><span class="dv">2</span>)) </span>
<span id="cb1221-5"><a href="adventures-in-covariance.html#cb1221-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1221-6"><a href="adventures-in-covariance.html#cb1221-6" aria-hidden="true" tabindex="-1"></a>post <span class="sc">%&gt;%</span> </span>
<span id="cb1221-7"><a href="adventures-in-covariance.html#cb1221-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(etasq<span class="sc">:</span>rhosq, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1221-8"><a href="adventures-in-covariance.html#cb1221-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(name, value) <span class="sc">%&gt;%</span> </span>
<span id="cb1221-9"><a href="adventures-in-covariance.html#cb1221-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb1221-10"><a href="adventures-in-covariance.html#cb1221-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean_hdi</span>(value, <span class="at">.width=</span>.<span class="dv">89</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1221-11"><a href="adventures-in-covariance.html#cb1221-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(.,<span class="at">digits=</span><span class="dv">2</span>)))</span></code></pre></div>
<pre><code>## # A tibble: 2 × 7
##   name  value .lower .upper .width .point .interval
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
## 1 etasq  0.22   0      0.43   0.89 mean   hdi      
## 2 rhosq  0.47   0.02   1      0.89 mean   hdi</code></pre>
<p>共分散<span class="math inline">\(\mathbf{K_{ij}}\)</span>の事前分布と事後分布は以下のようになる。ばらつきが大きいことが分かる。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-706-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>共分散行列の事後推定値は以下のとおりである。</p>
<div class="sourceCode" id="cb1223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1223-1"><a href="adventures-in-covariance.html#cb1223-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span><span class="dv">10</span>, <span class="at">ncol =</span><span class="dv">10</span>)</span>
<span id="cb1223-2"><a href="adventures-in-covariance.html#cb1223-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1223-3"><a href="adventures-in-covariance.html#cb1223-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb1223-4"><a href="adventures-in-covariance.html#cb1223-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb1223-5"><a href="adventures-in-covariance.html#cb1223-5" aria-hidden="true" tabindex="-1"></a>   k[i,j] <span class="ot">&lt;-</span> <span class="fu">median</span>(post<span class="sc">$</span>etasq)<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span><span class="fu">median</span>(post<span class="sc">$</span>rhosq)<span class="sc">*</span></span>
<span id="cb1223-6"><a href="adventures-in-covariance.html#cb1223-6" aria-hidden="true" tabindex="-1"></a>                                      islandsDistMatrix[i,j]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1223-7"><a href="adventures-in-covariance.html#cb1223-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">diag</span>(k) <span class="ot">&lt;-</span> <span class="fu">median</span>(post<span class="sc">$</span>etasq) <span class="sc">+</span> <span class="fl">0.01</span></span>
<span id="cb1223-8"><a href="adventures-in-covariance.html#cb1223-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1223-9"><a href="adventures-in-covariance.html#cb1223-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1223-10"><a href="adventures-in-covariance.html#cb1223-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(k) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(d_mat)</span>
<span id="cb1223-11"><a href="adventures-in-covariance.html#cb1223-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(k) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(d_mat)</span></code></pre></div>
<p><img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-708-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>相関行列は以下の通り。行列の左上の小さな社会が強い相関を持っていることが分かる。一方、ハワイ（Ha）は他の地域から離れているのでゼロである。</p>
<div class="sourceCode" id="cb1224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1224-1"><a href="adventures-in-covariance.html#cb1224-1" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">cov2cor</span>(k),<span class="dv">2</span>)</span>
<span id="cb1224-2"><a href="adventures-in-covariance.html#cb1224-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1224-3"><a href="adventures-in-covariance.html#cb1224-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(rho) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Ml&quot;</span>, <span class="st">&quot;Ti&quot;</span>, <span class="st">&quot;SC&quot;</span>, <span class="st">&quot;Ya&quot;</span>, <span class="st">&quot;Fi&quot;</span>, <span class="st">&quot;Tr&quot;</span>, <span class="st">&quot;Ch&quot;</span>, <span class="st">&quot;Mn&quot;</span>, <span class="st">&quot;To&quot;</span>, <span class="st">&quot;Ha&quot;</span>)</span>
<span id="cb1224-4"><a href="adventures-in-covariance.html#cb1224-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(rho) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(rho)</span></code></pre></div>
<p><img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-710-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>モデルの推定結果を図示したものが以下である。地理的に近い地域ほど事後平均が強く相関しており（A）、道具数も類似していることが読み取れる（B）。
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-713-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="example-phylogenetic-distance" class="section level3 hasAnchor" number="14.5.2">
<h3><span class="header-section-number">14.5.2</span> Example: Phylogenetic distance<a href="adventures-in-covariance.html#example-phylogenetic-distance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>空間的な距離だけでなく、時間的な距離に対しても同様の分析を施すことができる。例えば、系統上の距離を考慮した分析を施すことで複数の種を含むデータをうまく扱うことができる。系統関係は因果関係に2つの影響を与えうる。</p>
<ol style="list-style-type: decimal">
<li>最近分岐した種は類似した形質を多く持つ（まだ短時間しか異なる淘汰圧にさらされていないため）。<br />
</li>
<li>系統的な距離は、種間の共変動を生み出す観測できない要因の代わり（proxy）として用いることができる。例えば、鳥類には空を飛行することに起因する類似の要因が影響を与えている可能性が高い。</li>
</ol>
<p>集団サイズ(G)と脳容量(B)の関係を考える。社会脳仮説に従えば、集団サイズが大きいほど脳容量も大きいと予測される。この因果関係をDAGで表すと以下のようになる。添字は進化史上の異なる時点を表す。すなわち、<span class="math inline">\(G_{1}\)</span>と時点1における集団サイズを、<span class="math inline">\(G_{2}\)</span>は時点2における集団サイズを表す。また、Uは未観測の要因を表す。<br />
しかし、現実的には<span class="math inline">\(U\)</span>をコントロールできない。また、<span class="math inline">\(G_{1}\)</span>や<span class="math inline">\(B_{1}\)</span>も知ることができない。
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-714-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>このように観測できない過去の要因の影響を知るために、系統関係を用いることができる。DAGで表すと以下のようになる。Mは体重を示し、集団サイズと脳容量の両方に影響していると考えられる。未観測変数Uはいずれにも影響を与えていると考えられる。また系統的距離PはUに影響していると考えられる。バックドア基準を満たすためには、MとUで条件付けする必要がある。Mは説明変数に加えることで可能である。またUもPを用いて<strong>phylogenetic regression</strong>を行うことで統制可能である。<br />
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-715-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>それでは、実際にモデリングを行っていく。霊長類の系統樹を以下に示す。以下の分析では、この系統樹を用いて未観測要因Uをモデリングするとともに、分類群ごとの種数をコントロールする（例えば、キツネザルは他のサルに比べてデータが多いなど）。</p>
<div class="sourceCode" id="cb1225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1225-1"><a href="adventures-in-covariance.html#cb1225-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;Primates301&quot;</span>)</span>
<span id="cb1225-2"><a href="adventures-in-covariance.html#cb1225-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;Primates301_nex&quot;</span>)</span></code></pre></div>
<p><img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-717-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>系統関係を考慮したモデリングを行うに、まずはそれを考慮しない以下のモデルを考える。<span class="math inline">\(\mathbf{S}\)</span>は分散共分散行列を表し、<span class="math inline">\(\mathbf{I}\)</span>は単位行列である。すなわち、このモデルでは共分散が0であることを想定しているので、通常の回帰分析と同じである。</p>
<p><span class="math display">\[
\begin{aligned}
  \mathbf{B} &amp;\sim MVNormal(\mu, \mathbf{S})\\
  \mu_{i} &amp;= \alpha + \beta_{G} G_{i} + \beta_{M} M_{i}\\
  \mathbf{S} &amp;= \sigma^2\mathbf{I}
\end{aligned}
\]</span>
<br /></p>
<p>それでは、モデリングを行う。</p>
<div class="sourceCode" id="cb1226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1226-1"><a href="adventures-in-covariance.html#cb1226-1" aria-hidden="true" tabindex="-1"></a>d5 <span class="ot">&lt;-</span> </span>
<span id="cb1226-2"><a href="adventures-in-covariance.html#cb1226-2" aria-hidden="true" tabindex="-1"></a>  Primates301 <span class="sc">%&gt;%</span> </span>
<span id="cb1226-3"><a href="adventures-in-covariance.html#cb1226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">as.character</span>(name)) <span class="sc">%&gt;%</span> </span>
<span id="cb1226-4"><a href="adventures-in-covariance.html#cb1226-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(group_size, body, brain) <span class="sc">%&gt;%</span> </span>
<span id="cb1226-5"><a href="adventures-in-covariance.html#cb1226-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">m =</span> <span class="fu">log</span>(body) <span class="sc">%&gt;%</span> <span class="fu">standardize</span>(),</span>
<span id="cb1226-6"><a href="adventures-in-covariance.html#cb1226-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">b =</span> <span class="fu">log</span>(brain) <span class="sc">%&gt;%</span> <span class="fu">standardize</span>(),</span>
<span id="cb1226-7"><a href="adventures-in-covariance.html#cb1226-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">g =</span> <span class="fu">log</span>(group_size) <span class="sc">%&gt;%</span> <span class="fu">standardize</span>())</span></code></pre></div>
<div class="sourceCode" id="cb1227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1227-1"><a href="adventures-in-covariance.html#cb1227-1" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.9</span> <span class="ot">&lt;-</span> </span>
<span id="cb1227-2"><a href="adventures-in-covariance.html#cb1227-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span> d5,</span>
<span id="cb1227-3"><a href="adventures-in-covariance.html#cb1227-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1227-4"><a href="adventures-in-covariance.html#cb1227-4" aria-hidden="true" tabindex="-1"></a>      b <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> g <span class="sc">+</span> m,</span>
<span id="cb1227-5"><a href="adventures-in-covariance.html#cb1227-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">2.5</span>),<span class="at">class =</span> Intercept),</span>
<span id="cb1227-6"><a href="adventures-in-covariance.html#cb1227-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">2.5</span>), <span class="at">class =</span> b),</span>
<span id="cb1227-7"><a href="adventures-in-covariance.html#cb1227-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb1227-8"><a href="adventures-in-covariance.html#cb1227-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1227-9"><a href="adventures-in-covariance.html#cb1227-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span><span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.9&quot;</span></span>
<span id="cb1227-10"><a href="adventures-in-covariance.html#cb1227-10" aria-hidden="true" tabindex="-1"></a>      )</span></code></pre></div>
結果は以下の通り(表<a href="adventures-in-covariance.html#tab:res-b14-9">14.8</a>)。集団サイズと体重が脳容量に影響を与えているように見える。しかし、このモデルではバイアスを取り除くことができていないため、因果推論を行うことができない。<br />

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-9">表14.8: </span>b14.9の結果。
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_Intercept
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
-0.04
</td>
<td style="text-align:right;">
0.04
</td>
</tr>
<tr>
<td style="text-align:left;">
b_g
</td>
<td style="text-align:right;">
0.12
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
0.17
</td>
</tr>
<tr>
<td style="text-align:left;">
b_m
</td>
<td style="text-align:right;">
0.90
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
0.85
</td>
<td style="text-align:right;">
0.94
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
0.19
</td>
<td style="text-align:right;">
0.24
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-6.05
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
-6.08
</td>
<td style="text-align:right;">
-6.03
</td>
</tr>
</tbody>
</table>
<p>それでは、以下では2種類の<strong>phylogenetic regression</strong>を行う。どちらのモデルでも、先ほどのモデルの分散共分散行列<span class="math inline">\(\mathbf{S}\)</span>を系統的距離に基づいて変えるだけである。<br />
1つ目のモデルは、ブラウン運動（正規分布のランダムウォーク）に基づいて系統樹を解釈する。この方法では、種間の共分散が系統的距離に比例して小さくなることを仮定する。実際は、系統樹の異なる場所では進化速度が異なるはずだが、それについては考慮しない。Rでは<code>ape</code>パッケージを用いることで系統的距離を算出できる。</p>
<div class="sourceCode" id="cb1228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1228-1"><a href="adventures-in-covariance.html#cb1228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ape)</span>
<span id="cb1228-2"><a href="adventures-in-covariance.html#cb1228-2" aria-hidden="true" tabindex="-1"></a>spp_obs <span class="ot">&lt;-</span> d5<span class="sc">$</span>name</span>
<span id="cb1228-3"><a href="adventures-in-covariance.html#cb1228-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1228-4"><a href="adventures-in-covariance.html#cb1228-4" aria-hidden="true" tabindex="-1"></a>d6 <span class="ot">&lt;-</span> Primates301_nex</span>
<span id="cb1228-5"><a href="adventures-in-covariance.html#cb1228-5" aria-hidden="true" tabindex="-1"></a>tree_trimmed <span class="ot">&lt;-</span> <span class="fu">keep.tip</span>(d6, spp_obs)</span>
<span id="cb1228-6"><a href="adventures-in-covariance.html#cb1228-6" aria-hidden="true" tabindex="-1"></a>Rbm <span class="ot">&lt;-</span> <span class="fu">corBrownian</span>(<span class="at">phy =</span> tree_trimmed)</span>
<span id="cb1228-7"><a href="adventures-in-covariance.html#cb1228-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1228-8"><a href="adventures-in-covariance.html#cb1228-8" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> <span class="fu">vcv</span>(Rbm)</span>
<span id="cb1228-9"><a href="adventures-in-covariance.html#cb1228-9" aria-hidden="true" tabindex="-1"></a>Dmat <span class="ot">&lt;-</span> <span class="fu">cophenetic</span>(tree_trimmed)</span></code></pre></div>
<p>以下の図から、共分散は距離の逆数であることが分かる。
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-721-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>それでは、モデリングを行う。<code>brms</code>パッケージでは、<code>fcor()</code>で既知の共分散行列をモデルに組み込む。</p>
<div class="sourceCode" id="cb1229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1229-1"><a href="adventures-in-covariance.html#cb1229-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 相関行列に変換</span></span>
<span id="cb1229-2"><a href="adventures-in-covariance.html#cb1229-2" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> V[spp_obs, spp_obs]<span class="sc">/</span><span class="fu">max</span>(V)</span>
<span id="cb1229-3"><a href="adventures-in-covariance.html#cb1229-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1229-4"><a href="adventures-in-covariance.html#cb1229-4" aria-hidden="true" tabindex="-1"></a><span class="do">## モデリング </span></span>
<span id="cb1229-5"><a href="adventures-in-covariance.html#cb1229-5" aria-hidden="true" tabindex="-1"></a>b14<span class="fl">.10</span> <span class="ot">&lt;-</span> </span>
<span id="cb1229-6"><a href="adventures-in-covariance.html#cb1229-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span> d5,</span>
<span id="cb1229-7"><a href="adventures-in-covariance.html#cb1229-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">data2 =</span> <span class="fu">list</span>(<span class="at">R=</span>R),</span>
<span id="cb1229-8"><a href="adventures-in-covariance.html#cb1229-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1229-9"><a href="adventures-in-covariance.html#cb1229-9" aria-hidden="true" tabindex="-1"></a>      b <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> m <span class="sc">+</span> g <span class="sc">+</span> <span class="fu">fcor</span>(R),</span>
<span id="cb1229-10"><a href="adventures-in-covariance.html#cb1229-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">2.5</span>),<span class="at">class =</span> Intercept),</span>
<span id="cb1229-11"><a href="adventures-in-covariance.html#cb1229-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">student_t</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">2.5</span>), <span class="at">class =</span> b),</span>
<span id="cb1229-12"><a href="adventures-in-covariance.html#cb1229-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)),</span>
<span id="cb1229-13"><a href="adventures-in-covariance.html#cb1229-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1229-14"><a href="adventures-in-covariance.html#cb1229-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span><span class="dv">14</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14.10&quot;</span>)</span></code></pre></div>
結果は以下の通り（表<a href="adventures-in-covariance.html#tab:res-b14-10">14.9</a>）。集団サイズの影響がほとんど0になっていることが分かる。この結果から、近縁種ほど脳容量が類似しており、そのことによって集団サイズとの間に疑似相関が生じていたことが示唆される。<br />

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-10">表14.9: </span>b14.10の結果。
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_Intercept
</td>
<td style="text-align:right;">
-0.20
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
-0.52
</td>
<td style="text-align:right;">
0.13
</td>
</tr>
<tr>
<td style="text-align:left;">
b_m
</td>
<td style="text-align:right;">
0.70
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:right;">
0.77
</td>
</tr>
<tr>
<td style="text-align:left;">
b_g
</td>
<td style="text-align:right;">
-0.01
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
-0.05
</td>
<td style="text-align:right;">
0.03
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma
</td>
<td style="text-align:right;">
0.40
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
0.45
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-6.21
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
-6.26
</td>
<td style="text-align:right;">
-6.17
</td>
</tr>
</tbody>
</table>
<p>ブラウン運動モデルは、ガウス過程の特殊例である。ブラウン運動モデルを改良するため、<strong>Ornstein-Uhlenbeck Process</strong>（OU process）が用いられることがある。このモデルでは、系統的距離と共分散の間に以下のような非線形な関係を想定する。</p>
<p><span class="math display">\[
K_{i,j} = \eta^2 exp(-\rho^2 D_{ij})
\]</span>
<br /></p>
<p>前節のオセアニアの道具モデルと違う点は、距離が二乗されていないことである。OU processもガウス過程の一種である。現在<code>brms</code>ではOU過程をサポートしていないので、<code>rethinking</code>パッケージでモデリングを行う。</p>
<div class="sourceCode" id="cb1230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1230-1"><a href="adventures-in-covariance.html#cb1230-1" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> </span>
<span id="cb1230-2"><a href="adventures-in-covariance.html#cb1230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb1230-3"><a href="adventures-in-covariance.html#cb1230-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_spp =</span> <span class="fu">nrow</span>(d5),</span>
<span id="cb1230-4"><a href="adventures-in-covariance.html#cb1230-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">M     =</span> <span class="fu">standardize</span>(<span class="fu">log</span>(d5<span class="sc">$</span>body)),</span>
<span id="cb1230-5"><a href="adventures-in-covariance.html#cb1230-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">B     =</span> <span class="fu">standardize</span>(<span class="fu">log</span>(d5<span class="sc">$</span>brain)),</span>
<span id="cb1230-6"><a href="adventures-in-covariance.html#cb1230-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">G     =</span> <span class="fu">standardize</span>(<span class="fu">log</span>(d5<span class="sc">$</span>group_size)), </span>
<span id="cb1230-7"><a href="adventures-in-covariance.html#cb1230-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Imat  =</span> <span class="fu">diag</span>(<span class="fu">nrow</span>(d5)),</span>
<span id="cb1230-8"><a href="adventures-in-covariance.html#cb1230-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">V     =</span> V[spp_obs, spp_obs],</span>
<span id="cb1230-9"><a href="adventures-in-covariance.html#cb1230-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">R     =</span> V[spp_obs, spp_obs] <span class="sc">/</span> <span class="fu">max</span>(V[spp_obs, spp_obs]),</span>
<span id="cb1230-10"><a href="adventures-in-covariance.html#cb1230-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Dmat  =</span> Dmat[spp_obs, spp_obs] <span class="sc">/</span> <span class="fu">max</span>(Dmat)</span>
<span id="cb1230-11"><a href="adventures-in-covariance.html#cb1230-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1230-12"><a href="adventures-in-covariance.html#cb1230-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1230-13"><a href="adventures-in-covariance.html#cb1230-13" aria-hidden="true" tabindex="-1"></a>m14<span class="fl">.11</span> <span class="ot">&lt;-</span> </span>
<span id="cb1230-14"><a href="adventures-in-covariance.html#cb1230-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ulam</span>( </span>
<span id="cb1230-15"><a href="adventures-in-covariance.html#cb1230-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alist</span>(</span>
<span id="cb1230-16"><a href="adventures-in-covariance.html#cb1230-16" aria-hidden="true" tabindex="-1"></a>      B <span class="sc">~</span> <span class="fu">multi_normal</span>(mu, SIGMA),</span>
<span id="cb1230-17"><a href="adventures-in-covariance.html#cb1230-17" aria-hidden="true" tabindex="-1"></a>      mu <span class="ot">&lt;-</span> a <span class="sc">+</span> bM <span class="sc">*</span> M <span class="sc">+</span> bG <span class="sc">*</span> G,</span>
<span id="cb1230-18"><a href="adventures-in-covariance.html#cb1230-18" aria-hidden="true" tabindex="-1"></a>      matrix[N_spp,N_spp]<span class="sc">:</span> SIGMA <span class="ot">&lt;-</span> <span class="fu">cov_GPL1</span>(Dmat, etasq, rhosq, <span class="fl">0.01</span>), </span>
<span id="cb1230-19"><a href="adventures-in-covariance.html#cb1230-19" aria-hidden="true" tabindex="-1"></a>      a <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb1230-20"><a href="adventures-in-covariance.html#cb1230-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(bM,bG) <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb1230-21"><a href="adventures-in-covariance.html#cb1230-21" aria-hidden="true" tabindex="-1"></a>      etasq <span class="sc">~</span> <span class="fu">half_normal</span>(<span class="dv">1</span>, <span class="fl">0.25</span>),</span>
<span id="cb1230-22"><a href="adventures-in-covariance.html#cb1230-22" aria-hidden="true" tabindex="-1"></a>      rhosq <span class="sc">~</span> <span class="fu">half_normal</span>(<span class="dv">3</span>, <span class="fl">0.25</span>)</span>
<span id="cb1230-23"><a href="adventures-in-covariance.html#cb1230-23" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb1230-24"><a href="adventures-in-covariance.html#cb1230-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list, </span>
<span id="cb1230-25"><a href="adventures-in-covariance.html#cb1230-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>)</span></code></pre></div>
<p>結果は以下の通り（表<a href="adventures-in-covariance.html#tab:res-b14-11">14.10</a>）。集団サイズは小さいながらも、脳容量に影響を与えていることが分かる。</p>
<div class="sourceCode" id="cb1231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1231-1"><a href="adventures-in-covariance.html#cb1231-1" aria-hidden="true" tabindex="-1"></a><span class="fu">precis</span>(m14<span class="fl">.11</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1231-2"><a href="adventures-in-covariance.html#cb1231-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1231-3"><a href="adventures-in-covariance.html#cb1231-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;par&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1231-4"><a href="adventures-in-covariance.html#cb1231-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb1231-5"><a href="adventures-in-covariance.html#cb1231-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1231-6"><a href="adventures-in-covariance.html#cb1231-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption =</span> <span class="st">&quot;b14.11の結果。&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1231-7"><a href="adventures-in-covariance.html#cb1231-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">&quot;striped&quot;</span>, <span class="st">&quot;hold_position&quot;</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:res-b14-11">表14.10: </span>b14.11の結果。
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
X5.5.
</th>
<th style="text-align:right;">
X94.5.
</th>
<th style="text-align:right;">
n_eff
</th>
<th style="text-align:right;">
Rhat4
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
a
</td>
<td style="text-align:right;">
-0.06
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
-0.19
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
1809.88
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
bG
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
0.09
</td>
<td style="text-align:right;">
1839.62
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
bM
</td>
<td style="text-align:right;">
0.83
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.79
</td>
<td style="text-align:right;">
0.88
</td>
<td style="text-align:right;">
1473.26
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
etasq
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
2057.37
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
rhosq
</td>
<td style="text-align:right;">
2.80
</td>
<td style="text-align:right;">
0.23
</td>
<td style="text-align:right;">
2.42
</td>
<td style="text-align:right;">
3.18
</td>
<td style="text-align:right;">
2084.41
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<p><span class="math inline">\(K_{ij}\)</span>の事前分布と事後分布を描いたのが下図である。推定結果から、いずれの系統的距離においても種間のばらつきが小さいことが分かる。
<img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-724-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="practice-11" class="section level2 hasAnchor" number="14.6">
<h2><span class="header-section-number">14.6</span> Practice<a href="adventures-in-covariance.html#practice-11" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="m1-8" class="section level3 hasAnchor" number="14.6.1">
<h3><span class="header-section-number">14.6.1</span> 14M1<a href="adventures-in-covariance.html#m1-8" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<blockquote>
<p>Repeat the café robot simulation from the beginning of the chapter. This time, set rho to zero, so that there is no correlation between intercepts and slopes. How does the posterior distribution of the correlation reflect this change in the underlying simulation?</p>
</blockquote>
<p>本章冒頭のロボットの例で、ランダム切片とランダム傾きの間の相関をゼロにしてみる。</p>
<div class="sourceCode" id="cb1232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1232-1"><a href="adventures-in-covariance.html#cb1232-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fl">3.5</span>         <span class="co"># averange morning wait time  </span></span>
<span id="cb1232-2"><a href="adventures-in-covariance.html#cb1232-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="dv">1</span>)          <span class="co"># average difference afternoon wait time  </span></span>
<span id="cb1232-3"><a href="adventures-in-covariance.html#cb1232-3" aria-hidden="true" tabindex="-1"></a>sigma_a <span class="ot">&lt;-</span> <span class="dv">1</span>     <span class="co"># std dev in intercepts   </span></span>
<span id="cb1232-4"><a href="adventures-in-covariance.html#cb1232-4" aria-hidden="true" tabindex="-1"></a>sigma_b <span class="ot">&lt;-</span> <span class="fl">0.5</span>   <span class="co"># std dev in slopes  </span></span>
<span id="cb1232-5"><a href="adventures-in-covariance.html#cb1232-5" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="dv">0</span>     <span class="co"># correlation between interecpts and slopes</span></span>
<span id="cb1232-6"><a href="adventures-in-covariance.html#cb1232-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1232-7"><a href="adventures-in-covariance.html#cb1232-7" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(a,b) </span>
<span id="cb1232-8"><a href="adventures-in-covariance.html#cb1232-8" aria-hidden="true" tabindex="-1"></a>cov_ab <span class="ot">&lt;-</span> sigma_a<span class="sc">*</span>sigma_b<span class="sc">*</span>rho <span class="co">#共分散</span></span>
<span id="cb1232-9"><a href="adventures-in-covariance.html#cb1232-9" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(sigma_a<span class="sc">^</span><span class="dv">2</span>, cov_ab, </span>
<span id="cb1232-10"><a href="adventures-in-covariance.html#cb1232-10" aria-hidden="true" tabindex="-1"></a>                  cov_ab, sigma_b<span class="sc">^</span><span class="dv">2</span>), <span class="at">ncol=</span><span class="dv">2</span>)　<span class="co"># 分散共分散行列</span></span></code></pre></div>
<div class="sourceCode" id="cb1233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1233-1"><a href="adventures-in-covariance.html#cb1233-1" aria-hidden="true" tabindex="-1"></a>n_cafes <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb1233-2"><a href="adventures-in-covariance.html#cb1233-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1233-3"><a href="adventures-in-covariance.html#cb1233-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5</span>)</span>
<span id="cb1233-4"><a href="adventures-in-covariance.html#cb1233-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1233-5"><a href="adventures-in-covariance.html#cb1233-5" aria-hidden="true" tabindex="-1"></a>vary_effects <span class="ot">&lt;-</span> </span>
<span id="cb1233-6"><a href="adventures-in-covariance.html#cb1233-6" aria-hidden="true" tabindex="-1"></a>  MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n_cafes, mu, sigma) <span class="sc">%&gt;%</span> </span>
<span id="cb1233-7"><a href="adventures-in-covariance.html#cb1233-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1233-8"><a href="adventures-in-covariance.html#cb1233-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="st">&quot;a_cafe&quot;</span>, <span class="st">&quot;b_cafe&quot;</span>)</span>
<span id="cb1233-9"><a href="adventures-in-covariance.html#cb1233-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1233-10"><a href="adventures-in-covariance.html#cb1233-10" aria-hidden="true" tabindex="-1"></a>n_visits <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb1233-11"><a href="adventures-in-covariance.html#cb1233-11" aria-hidden="true" tabindex="-1"></a>sigma_y <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1233-12"><a href="adventures-in-covariance.html#cb1233-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1233-13"><a href="adventures-in-covariance.html#cb1233-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb1233-14"><a href="adventures-in-covariance.html#cb1233-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1233-15"><a href="adventures-in-covariance.html#cb1233-15" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> </span>
<span id="cb1233-16"><a href="adventures-in-covariance.html#cb1233-16" aria-hidden="true" tabindex="-1"></a>  vary_effects <span class="sc">%&gt;%</span> </span>
<span id="cb1233-17"><a href="adventures-in-covariance.html#cb1233-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cafe =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb1233-18"><a href="adventures-in-covariance.html#cb1233-18" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">expand</span>(<span class="fu">nesting</span>(cafe, a_cafe, b_cafe),</span>
<span id="cb1233-19"><a href="adventures-in-covariance.html#cb1233-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">visits =</span> <span class="dv">1</span><span class="sc">:</span>n_visits) <span class="sc">%&gt;%</span> </span>
<span id="cb1233-20"><a href="adventures-in-covariance.html#cb1233-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">afternoon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">times =</span> <span class="fu">n</span>()<span class="sc">/</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1233-21"><a href="adventures-in-covariance.html#cb1233-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mu =</span> a_cafe <span class="sc">+</span> b_cafe<span class="sc">*</span>afternoon) <span class="sc">%&gt;%</span> </span>
<span id="cb1233-22"><a href="adventures-in-covariance.html#cb1233-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wait =</span> <span class="fu">rnorm</span>(<span class="at">n=</span><span class="fu">n</span>(), <span class="at">mean=</span>mu, <span class="at">sd=</span>sigma_y))</span></code></pre></div>
<p>それでは、モデリングを行う。</p>
<div class="sourceCode" id="cb1234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1234-1"><a href="adventures-in-covariance.html#cb1234-1" aria-hidden="true" tabindex="-1"></a>b14M1 <span class="ot">&lt;-</span> </span>
<span id="cb1234-2"><a href="adventures-in-covariance.html#cb1234-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span>dat,</span>
<span id="cb1234-3"><a href="adventures-in-covariance.html#cb1234-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1234-4"><a href="adventures-in-covariance.html#cb1234-4" aria-hidden="true" tabindex="-1"></a>      wait <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> afternoon <span class="sc">+</span> (<span class="dv">1</span><span class="sc">+</span>afternoon<span class="sc">|</span>cafe),</span>
<span id="cb1234-5"><a href="adventures-in-covariance.html#cb1234-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb1234-6"><a href="adventures-in-covariance.html#cb1234-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">class =</span> b),</span>
<span id="cb1234-7"><a href="adventures-in-covariance.html#cb1234-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma),</span>
<span id="cb1234-8"><a href="adventures-in-covariance.html#cb1234-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span>sd),</span>
<span id="cb1234-9"><a href="adventures-in-covariance.html#cb1234-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">2</span>), <span class="at">class =</span> cor)),</span>
<span id="cb1234-10"><a href="adventures-in-covariance.html#cb1234-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1234-11"><a href="adventures-in-covariance.html#cb1234-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">155</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14M1&quot;</span>)</span></code></pre></div>
<p>推定値もほとんどゼロになる。</p>
<div class="sourceCode" id="cb1235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1235-1"><a href="adventures-in-covariance.html#cb1235-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_summary</span>(b14M1) <span class="sc">%&gt;%</span> </span>
<span id="cb1235-2"><a href="adventures-in-covariance.html#cb1235-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1235-3"><a href="adventures-in-covariance.html#cb1235-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;par&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1235-4"><a href="adventures-in-covariance.html#cb1235-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(par,<span class="st">&quot;cor&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1235-5"><a href="adventures-in-covariance.html#cb1235-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>,</span>
<span id="cb1235-6"><a href="adventures-in-covariance.html#cb1235-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1235-7"><a href="adventures-in-covariance.html#cb1235-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="fu">c</span>(<span class="st">&quot;striped&quot;</span>, <span class="st">&quot;hold_position&quot;</span>))</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
cor_cafe__Intercept__afternoon
</td>
<td style="text-align:right;">
-0.04
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
-0.45
</td>
<td style="text-align:right;">
0.38
</td>
</tr>
</tbody>
</table>
</div>
<div id="m2-8" class="section level3 hasAnchor" number="14.6.2">
<h3><span class="header-section-number">14.6.2</span> 14M2<a href="adventures-in-covariance.html#m2-8" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<blockquote>
<p>Fit this multilevel model to the simulated café data:</p>
</blockquote>
<p><span class="math display">\[
\begin{aligned}
  W_{i} &amp;\sim Normal(\mu_{i}, \sigma)\\
  \mu_{i} &amp;= \alpha_{cafe[i]} + \beta_{cafe[i]}A_{i}\\
    \alpha_{cafe} &amp;\sim Normal(\alpha, \sigma_{\alpha}) \\
    \beta_{cafe}  &amp;\sim Normal(\beta, \sigma_{\beta})\\
  \alpha &amp;\sim Normal(0,10)\\
  \beta &amp;\sim Normal(0,10)\\
  \sigma &amp;\sim HalfCauchy(0,1)\\
  \sigma_{\alpha} &amp;\sim HalfCauchy(0,1)\\
  \sigma_{\beta} &amp;\sim HalfCauchy(0,1)\\
\end{aligned}
\]</span></p>
<blockquote>
<p>Use WAIC to compare this model to the model from the chapter, the one that uses a multi-variate Gaussian prior. Explain the result.</p>
</blockquote>
<p>本章冒頭のシミュレーションデータで、ランダム切片とランダム傾きの間に相関を仮定しない（それぞれが独立に得られる）モデルを考える。<code>brms</code>では、<code>(1+afternoon||cafe)</code>のように書くことで、ランダム切片とランダム傾きの相関を考慮しないモデルを作れる。</p>
<div class="sourceCode" id="cb1236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1236-1"><a href="adventures-in-covariance.html#cb1236-1" aria-hidden="true" tabindex="-1"></a>b14M2 <span class="ot">&lt;-</span> </span>
<span id="cb1236-2"><a href="adventures-in-covariance.html#cb1236-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(<span class="at">data =</span>d,</span>
<span id="cb1236-3"><a href="adventures-in-covariance.html#cb1236-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> gaussian,</span>
<span id="cb1236-4"><a href="adventures-in-covariance.html#cb1236-4" aria-hidden="true" tabindex="-1"></a>      wait <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> afternoon <span class="sc">+</span> (<span class="dv">1</span><span class="sc">+</span>afternoon<span class="sc">||</span>cafe),</span>
<span id="cb1236-5"><a href="adventures-in-covariance.html#cb1236-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb1236-6"><a href="adventures-in-covariance.html#cb1236-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="at">class =</span> b),</span>
<span id="cb1236-7"><a href="adventures-in-covariance.html#cb1236-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma),</span>
<span id="cb1236-8"><a href="adventures-in-covariance.html#cb1236-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span>sd)),</span>
<span id="cb1236-9"><a href="adventures-in-covariance.html#cb1236-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,</span>
<span id="cb1236-10"><a href="adventures-in-covariance.html#cb1236-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> <span class="dv">155</span>, <span class="at">file =</span> <span class="st">&quot;output/Chapter14/b14M2&quot;</span>)  </span></code></pre></div>
<code>b14.1</code>の結果と比較してみる。推定結果に大きな違いはなさそう。<br />

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-730">表14.11: </span>b14.1の結果
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_Intercept
</td>
<td style="text-align:right;">
3.65
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
3.23
</td>
<td style="text-align:right;">
4.07
</td>
</tr>
<tr>
<td style="text-align:left;">
b_afternoon
</td>
<td style="text-align:right;">
-1.13
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
-1.41
</td>
<td style="text-align:right;">
-0.86
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_cafe__Intercept
</td>
<td style="text-align:right;">
0.96
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
0.69
</td>
<td style="text-align:right;">
1.36
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_cafe__afternoon
</td>
<td style="text-align:right;">
0.60
</td>
<td style="text-align:right;">
0.13
</td>
<td style="text-align:right;">
0.38
</td>
<td style="text-align:right;">
0.88
</td>
</tr>
<tr>
<td style="text-align:left;">
cor_cafe__Intercept__afternoon
</td>
<td style="text-align:right;">
-0.50
</td>
<td style="text-align:right;">
0.18
</td>
<td style="text-align:right;">
-0.80
</td>
<td style="text-align:right;">
-0.08
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma
</td>
<td style="text-align:right;">
0.47
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.53
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-5.07
</td>
<td style="text-align:right;">
0.44
</td>
<td style="text-align:right;">
-6.09
</td>
<td style="text-align:right;">
-4.38
</td>
</tr>
</tbody>
</table>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-731">表14.12: </span>b14M2の結果。
</caption>
<thead>
<tr>
<th style="text-align:left;">
par
</th>
<th style="text-align:right;">
Estimate
</th>
<th style="text-align:right;">
Est.Error
</th>
<th style="text-align:right;">
Q2.5
</th>
<th style="text-align:right;">
Q97.5
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
b_Intercept
</td>
<td style="text-align:right;">
3.64
</td>
<td style="text-align:right;">
0.21
</td>
<td style="text-align:right;">
3.22
</td>
<td style="text-align:right;">
4.06
</td>
</tr>
<tr>
<td style="text-align:left;">
b_afternoon
</td>
<td style="text-align:right;">
-1.13
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
-1.43
</td>
<td style="text-align:right;">
-0.85
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_cafe__Intercept
</td>
<td style="text-align:right;">
0.94
</td>
<td style="text-align:right;">
0.16
</td>
<td style="text-align:right;">
0.68
</td>
<td style="text-align:right;">
1.31
</td>
</tr>
<tr>
<td style="text-align:left;">
sd_cafe__afternoon
</td>
<td style="text-align:right;">
0.57
</td>
<td style="text-align:right;">
0.13
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
0.86
</td>
</tr>
<tr>
<td style="text-align:left;">
sigma
</td>
<td style="text-align:right;">
0.48
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.43
</td>
<td style="text-align:right;">
0.53
</td>
</tr>
<tr>
<td style="text-align:left;">
lprior
</td>
<td style="text-align:right;">
-8.48
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
-8.97
</td>
<td style="text-align:right;">
-8.11
</td>
</tr>
</tbody>
</table>
<p>図示してみると、結果は類似している。しかし、切片と傾きの相関は<code>b14.1</code>では-0.62、<code>b14M2</code>では-0.52で、相関を仮定したモデルの方が高いことが分かる。</p>
<p><img src="Rethinking_Bookdown_files/figure-html/unnamed-chunk-733-1.png" width="672" style="display: block; margin: auto;" /></p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-angrist1991" class="csl-entry">
Angrist JD, Keueger AB (1991) Does compulsory school attendance affect schooling and earnings? The Quarterly Journal of Economics 106:979–1014
</div>
<div id="ref-Cohen2014" class="csl-entry">
Cohen L, Malloy CJ (2014) Friends in high places. American Economic Journal: Economic Policy 6:63–91
</div>
<div id="ref-Koster2014" class="csl-entry">
Koster JM, Leckie G (2014) Food sharing networks in lowland nicaragua: An application of the social relations model to count data. Soc Networks 38:100–110
</div>
<div id="ref-Silk2005" class="csl-entry">
Silk JB, Brosnan SF, Vonk J, et al (2005) Chimpanzees are indifferent to the welfare of unrelated group members. Nature 437:1357–1359
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="models-with-memory.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="実行環境.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
